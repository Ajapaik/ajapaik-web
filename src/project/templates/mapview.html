{% extends "base.html" %}
{% load i18n %}

{% block layout %}
<script type="text/javascript">
	var map;
	var geotagged_photos={{ json_data|safe }};

	function initialize() {
		// Will load the base map layer and return it
		{% if filters.filters_by_name.city_lookup_filter.get_option_object %}
		map = get_map([{{ filters.filters_by_name.city_lookup_filter.get_option_object.lon }}, {{ filters.filters_by_name.city_lookup_filter.get_option_object.lat }}], 13);
		{% else %}
		map = get_map();
		{% endif %}

		var markers = [];
		for (var i in geotagged_photos) {
			var p=geotagged_photos[i];
			var thumb = p[1];
			//var image = '/media/gfx/' + (p[4] ? 'icon_camera_hot.png' : 'icon_camera.png');
			var image = {
				url: p[1],
				anchor: new google.maps.Point(19, 48),
				scaledSize: new google.maps.Size(32, 32)
			};
			var border = {
				url: '/media/gfx/' + (p[4] ? 'ajapaik_sinine_38px.png' : 'ajapaik_must_38px.png'),
				anchor: new google.maps.Point(22, 52),
				scaledSize: new google.maps.Size(38, 48)
			};
			var marker = new google.maps.Marker({
					map: map,
					id: p[0],
					thumb: thumb,
					position: new google.maps.LatLng(p[3],p[2]), 
					zIndex: p[4] ? 1 : 0,
					shadow:border,
					icon:image
				});
			
			(function(id) {
				google.maps.event.addListener(marker, 'click', function() {
					loadPhoto(id);
				});
			})(p[0]);
			markers.push(marker);
		}

		/*
		var clusterStyles = [
			{
				textColor: 'green',
				url: '/media/gfx/ajapaik_klaster_hall_38px.png',
				width: 38,
				height: 40
			},
			{
				textColor: 'orange',
				url: '/media/gfx/ajapaik_klaster_hall_38px.png',
				width: 38,
				height: 40
			},
			{
				textColor: 'red',
				url: '/media/gfx/ajapaik_klaster_hall_38px.png',
				width: 38,
				height: 40
			}
		];
		*/
		var clusterStyles = [{
				textColor: 'black',
				url: '/media/gfx/ajapaik_klaster_hall_38px.png',
				width: 38,
				height: 40
			}];

		var markerCluster = new MarkerClusterer(map, markers, {
			styles: clusterStyles,
			gridSize: 50,
			zoomOnClick: false
		});

		google.maps.event.addListener(markerCluster, 'clusterclick',
			function(clickedCluster){
				var markers = clickedCluster.getMarkers();
				var browser_content = '';
				var i = 0;
				for (marker in markers) {
					if (++i > 20) {
						map.panTo(clickedCluster.getCenter());
						map.fitBounds(clickedCluster.getBounds());
						break;
					}
					browser_content += '<div class="item'+ (markers[marker].zIndex ? ' hot' : '') +'"><a href="javascript:void(0);" onclick="loadPhoto('+ markers[marker].id +');$.modal.close();"><img src="'+ markers[marker].thumb +'" border="0" /></a></div>';
				}
				$('#photo_browser #browser_list').html(browser_content);
				$('#photo_browser').modal();
			}
		);
	};
	$(document).ready(initialize);
</script>

<div id="browse">

	<div class="top">

		<h1 class="ir"><a href="/?city={{city_select_form.cleaned_data.city}}">{% trans "Timepatch (Ajapaik)" %}</a></h1>

		<ul id="nav"></ul>

		<!--
		<div id="city_select">
			{{ city_select_form.as_p }}
			<script type="text/javascript">
				$('#id_city').change(function() {
					location.href = '{{ request.path }}?city=' + $(this).val();
				});
			</script>
		</div>
		-->

        <div class="filter-box">
            {{ filters.get_form.as_p }}
        </div>
        
		{% get_language_info for LANGUAGE_CODE as lang %}
		<div class="lang-box">
			<form style="display:inline;" action="/i18n/setlang/" method="post">
				{% csrf_token %}
				<div id="langmenu">
					<div>{{ lang.code|upper }}</div>
					<input name="next" type="hidden" value="{{ redirect_to }}" />
					<select id="language" name="language" onchange="this.form.submit();">
						{% get_language_info_list for LANGUAGES as languages %}
						{% for language in languages %}
						<option value="{{ language.code }}" title="{% trans language.name %} ({{ language.name_local }}) - {{ language.code|upper }}"{% if language.code == lang.code %} selected="selected"{% endif %}>{{ language.name_local|title }}</option>
						{% endfor %}
					</select>
				</div>
				<span id="langlabel">{% trans "Choose language" %}:</span>
			</form>
		</div>
	</div><!-- .top -->

	<div id="photo-drawer">
	</div>

	<div class="map">
		<div id="map_canvas" style="width: 100%; height: 100%"></div>
	</div>

</div><!-- #browse -->

<div style="display: none;">
	<div id="photo_browser">
		<div id="browser_list"></div>
		<a style="clear:both;" href="javascript:void(0);" onclick="$.modal.close();">{% trans "Close" %}</a>
	</div>
</div>

<script type="text/javascript" src="{{ MEDIA_URL }}js/browse.js"></script>

{% endblock layout %}
