{% extends 'layouts/frontpage.html' %}
{% load thumbnail i18n %}
{% block content %}
    
    <div id="wheel" style="width:100%;height:330px;border:1px solid #000;">
        {% for photo in photos %}
        {% thumbnail photo.image "160x160" as im %}
        <div class="image" style="width:160px;height:160px;border:1px solid #aaa;float:left;"><a id="photo_{{ photo.id }}" href="{% thumbnail photo.image "510x375" as bim %}{{ bim.url }}{% endthumbnail %}"><img src="{{ im.url }}" /></a></div>
        {% endthumbnail %}
        {% endfor %}
    </div>
    
    <div style="width:510px;height:510px">
        <img id="current_image" src="" />
    </div>
    
    <div id="map_canvas" style="width:512px;height:320px;">
    
    </div>
    
    <form id="geotag_form" action="{% url views.index %}" method="post">
        {{ geotag_form.as_p }}
        <input type="submit" value="{% trans "Salvesta" %}" />
    </form>
    
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.10/jquery-ui.min.js"></script>    
    <script type="text/javascript">
        // create stack from dom elements
        // later to be replaced by json from ajax
        function create_stack(images) {
            var data = [];
            $(images).each(function(idx,img) {
                data.push({
                    'id': $(img).find('a').attr('id'),
                    'big_image': $(img).find('a').attr('href'),
                    'small_image': $(img).find('img').attr('src')
                });
            });
            return data;
        }
        // Temporary event creator
        function show(num) {
            wheel.setTagged(true);
            wheel.advance();
        }
        
        
        Wheel = function(container) {
            this._stack = [];
            this._container = container;
            this._idx = 0;
            
            // Display settings
            this.total_cells = 5;
            this.selected_cell = 3;
        };
        Wheel.prototype = {
            addData: function(pictures_json) {
                $.merge(this._stack, pictures_json);
            },
            
            setTagged: function() {
                var frame = this.getCurrent();
                frame['tagged'] = true;
            },
            
            advance: function() {
                this._idx++;
                if (this._idx > this._stack.length-1) this._idx = this._stack.length-1;
                if (this._idx < 0) this._idx = 0;
                
                this.update();
            },
            
            getCurrent: function() {
                return this._stack[this._idx];
            },
            
            update: function(){
                // render stuff
                var data = this.getCurrent();
                var selected = $('#'+data['id']);
                var img = $(selected).find('img');
                
                var w = img.width();
                var h = img.height();
                img.css({
                    width: w,
                    height: h
                }).attr('src', data['big_image']);
                
                $(selected).find('img').animate({
                    width: 510,
                    height: 375,
                });
            }
        
        };
        
        var wheel = new Wheel($('#wheel'));
        $.getJSON('{% url views.fetch_stream %}', function(data){
            wheel.addData(data);
            wheel.update();
        });
    </script>
    
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?libraries=geometry&sensor=true&region=ET"></script>
    <script type="text/javascript">
        var tallinn = new google.maps.LatLng(59.435474, 24.750309);
        var form = $('#geotag_form');
        
        var options = {
            zoom: 13,
            center: tallinn,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        }    
    
        function toggleBounce() {
            if (marker.getAnimation() != null) {
                marker.setAnimation(null);
            } else {
                marker.setAnimation(google.maps.Animation.BOUNCE);
            }
        }
        
        $('#wheel>div>a').click(function(){
            $('#current_image').attr('src', $(this).attr('href'));
            form.find('[name="photo_id"]').val($(this).attr('id').substr(6));
            
            var map = new google.maps.Map(document.getElementById("map_canvas"), options);        
            marker = new google.maps.Marker({
                map:map,
                draggable:true,
                animation: google.maps.Animation.DROP,
                position: tallinn
            });
            google.maps.event.addListener(marker, 'dragend', function(){
                form.find('[name="lat"]').val(this.getPosition().lat());
                form.find('[name="lon"]').val(this.getPosition().lng());
            });
            google.maps.event.addListener(marker, 'click', toggleBounce);
            
            return false;
        });
    </script>
    
{% endblock %}