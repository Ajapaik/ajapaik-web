{% load thumbnail i18n %}

<script>
cityId = "{{ photo.city_id }}";
$(document).ready(function() {
	History.replaceState(null, '{{ title }} - {% trans "Timepatch (Ajapaik)" %}', '{% if photo.rephotos.all.0 %}{{ photo.rephotos.all.0.get_absolute_url }}{% else %}{{ photo.get_absolute_url }}{% endif %}');
	$('.filter-box').hide();
	_gaq.push(['_trackPageview', '{% if photo.rephotos.all.0 %}{{ photo.rephotos.all.0.get_absolute_url }}{% else %}{{ photo.get_absolute_url }}{% endif %}']);
	{% if photo.lat and photo.lon %}
	map.panTo(new google.maps.LatLng({{ photo.lat }}, {{ photo.lon }}));
	{% endif %}
});
</script>
<div class="photos clearfix">

	<div class="browse-nav">
		<a href="{{ photo.get_absolute_url }}" class="btn green medium" title="{% trans "Add rephoto" %}">{% trans "Add rephoto" %} ({{ photo.rephotos.count }})</a>
		<!--<a href="#" class="add-rephoto btn green medium" title="{% trans "Add rephoto" %}">{% trans "Add rephoto" %} ({{ photo.rephotos.count }})</a>-->
		<a href="{{ photo.get_heatmap_url }}" class="btn medium green iframe" title="{% trans "Heat map" %}">{% trans "Heat map" %}</a>
		<div class="clearfix"></div>
		<div id="add-comment">
			<a href="{% if photo.rephotos.all.0 %}{{ photo.rephotos.all.0.get_absolute_url }}{% else %}{{ photo.get_absolute_url }}{% endif %}" class="btn green medium" title="{% trans "Add comment" %}">{% trans "Add comment" %} (<fb:comments-count href="{{ hostname }}{% if photo.rephotos.all.0 %}{{ photo.rephotos.all.0.get_detail_url }}{% else %}{{ photo.get_detail_url }}{% endif %}"></fb:comments-count>)</a>
		</div>
		<a href="#" id="close-photo-drawer" class="btn medium" title="{% trans "Close photo" %}">{% trans "Close photo" %}</a>
		<a href="#" id="random-photo" class="btn shuffle" onClick="_gaq.push(['_trackEvent', 'Photo', 'Random']);" title="{% trans "Random" %}">&nbsp;</a>
		<script>
		var rephoto_comment = [];
		{% for rephoto in photo.rephotos.all %}
			rephoto_comment[{{ rephoto.id }}] = '<a href="{{ rephoto.get_absolute_url }}" class="btn green medium">{% trans "Add comment" %} (<fb:comments-count href="{{ hostname }}{{ rephoto.get_detail_url }}"></fb:comments-count>)</a>';
		{% endfor %}
		</script>
	</div><!-- .browse-nav -->

	<div class="original photo-item">
		{% thumbnail photo.image "700x400" as im %}
		<a class="fullscreen" id="full-thumb1" rel="{{ photo.id }}" href="{{ photo.get_absolute_url }}"><img src="{{ im.url }}" border="0" /></a>
		{% endthumbnail %}
		
		<div class="tools">
			<div class="description">
				<p>{{ photo.description }}</p>
				<p class="owner">
				{% if photo.source_url %}
					<a href="{{ photo.source_url }}" target="_blank">{{ photo.source.description }}{% if photo.source_key %} {{ photo.source_key }}{% endif %}</a>
				{% else %}
					{{ photo.source.description }}{% if photo.source_key %} {{ photo.source_key }}{% endif %}
				{% endif %}
				</p>
			</div>
		</div>
	</div><!-- .original.photo-item -->

	{% thumbnail photo.rephotos.all.0.image "700x400" as rephoto %}

	<div class="rephoto photo-item">
		<div class="container">
			<div class="meta">
				<div class="content" id="meta_content">
					{% if photo.rephotos.all.0.user.fb_name %}<p class="owner"><img style="padding-right: 10px;float: left;height: 30px;" src="{{ MEDIA_URL }}gfx/cc-at-sa.png" title="Creative Commons Attribution-ShareAlike" /><a href="{{ photo.rephotos.all.0.user.fb_link }}" target="_blank"><img style="width:30px;height:30px;" src="http://graph.facebook.com/{{ photo.rephotos.all.0.user.fb_id }}/picture?type=square" title="{{ photo.rephotos.all.0.user.fb_name }}" /></a></p>{% endif %}
					<p style="float:right;"> {% if photo.rephotos.all.0.date %}{{ photo.rephotos.all.0.date|date:"F d, Y" }}{% else %}{{ photo.rephotos.all.0.created|date:"F d, Y" }}{% endif %}</p>
				</div>
				<script>
				var rephoto_meta = [];
				{% for rephoto in photo.rephotos.all %}
					rephoto_meta[{{ rephoto.id }}] = '{% if rephoto.user.fb_name %}<p class="owner"><img style="padding-right: 10px;float: left;height: 30px;" src="{{ MEDIA_URL }}gfx/cc-at-sa.png" title="Creative Commons Attribution-ShareAlike" /><a href="{{ rephoto.user.fb_link }}" target="_blank"><img style="width:30px;height:30px;" src="http://graph.facebook.com/{{ rephoto.user.fb_id }}/picture?type=square" title="{{ rephoto.user.fb_name }}" /></a></p>{% endif %}<p style="float:right;"> {% if rephoto.date %}{{ rephoto.date|date:"F d, Y" }}{% else %}{{ rephoto.created|date:"F d, Y" }}{% endif %}</p>';
				{% endfor %}
				</script>
			</div>

			<div id="rephoto_content">
				<a class="fullscreen" id="full-thumb2" rel="{{ photo.rephotos.all.0.id }}" href="{{ photo.rephotos.all.0.get_absolute_url }}"><img src="{{ rephoto.url }}" border="0" /></a>
			</div>
			<script>
			var rephoto_img_href = [];
			var rephoto_img_src = [];
			var rephoto_img_src_fs = [];
			{% for rephoto in photo.rephotos.all %}
				rephoto_img_href[{{ rephoto.id }}] = '{{ rephoto.get_absolute_url }}';
				{% thumbnail rephoto.image "700x400" as image %}
					rephoto_img_src[{{ rephoto.id }}] = '{{ image.url }}';
				{% endthumbnail %}
				{% thumbnail rephoto.image "1024x1024" upscale=False as image %}
					rephoto_img_src_fs[{{ rephoto.id }}] = '{{ image.url }}';
				{% endthumbnail %}
			{% endfor %}
			</script>
		</div>

		<div class="tools">
			<ul class="thumbs">
				{% for rephoto_item in photo.rephotos.all %}
				<li class="photo{% if rephoto_item.id == photo.rephotos.all.0.id %} current{% endif %}"><a href="{{ rephoto_item.get_absolute_url }}" rel="{{ rephoto_item.id }}" title="{% if rephoto_item.user.fb_name %}{{ rephoto_item.user.fb_name }}{% endif %}"><img src="{% thumbnail rephoto_item.image "50x50" crop="center" as thumb %}{{ thumb.url }}{% endthumbnail %}" /></a></li>
				{% endfor %}
			</ul>
		</div><!-- .tools -->

	</div><!-- .rephoto.photo-item -->

	{% empty %}

	<div class="no-rephoto">
		<p>{% trans "Make a contemporary rephoto from the very same place where the historic picture was taken and upload it." %}</p>
	</div><!-- .no-refoto -->

	{% endthumbnail %}

</div><!-- .photos -->

<div class="full-box">
	<div class="full-pic" id="full-large1">
		{% thumbnail photo.image "1024x1024" upscale=False as full %}
		<img src="{{ full.url }}" border="0" />
		{% endthumbnail %}
	</div>
	<div class="full-pic" id="full-large2">
		{% thumbnail photo.rephotos.all.0.image "1024x1024" upscale=False as full %}
		<img src="{{ full.url }}" border="0" />
		{% endthumbnail %}
	</div>
</div><!-- .full-box -->

<script>
$('#photo-drawer .original img').load(function() {
	$('.no-rephoto').css('width', $(this).css('width') );
});

prepareFullscreen();
</script>

<div id="notice-container" style="display: none">

	<div id="notice" style="width: 400px;">
		<script src="{{ MEDIA_URL }}js/jquery.html5_upload.js" type="text/javascript"></script>
		<script type="text/javascript">
		$(function() {
			$("#upload_field").html5_upload({
				autostart: true,
				stopOnFirstError: false,
				url: function(number) {
					return '{% url views.photo_upload photo.pk %}';
					//return prompt(number + " url", "/");
				},
				onBrowserIncompatible: function() {
					$("#upload_field").attr('disabled', 'disabled');
				},
				sendBoundary: window.FormData || $.browser.mozilla,
				setName: function(text) {
					$("#progress_report_name").text(text);
				},
				setStatus: function(text) {
					$("#progress_report_status").text(text);
				},
				setProgress: function(val) {
					$("#progress_report_bar").css('width', Math.ceil(val*100)+"%");
				},
				onStart: function(event, total) {
					return true;
				},
				onStartOne: function(event, name, number, total) {
					return confirm(gettext('You have selected one photo for uploading. Continue?'));
				},
				onFinish: function(event, total) {
					return true;
				},
				onFinishOne: function(event, response, name, number, total) {
					uploadCompleted($.parseJSON(response));
				}
			});
		});
		</script>

		<p>{% trans "Make a contemporary rephoto from the very same place where the historic picture was taken and upload it." %}</p>

		{% if request.user.is_authenticated and request.user.get_profile.fb_id %}
			{% with profile=request.user.get_profile user=request.user %}
			<p>{% blocktrans with "<a href='/logout'>" as link_open and "</a>" as link_close and user.get_full_name as account_name %}Account ({{ account_name }}) connected with Facebook. If it's not you then {{ link_open }}click here{{ link_close }}.{% endblocktrans %}</p>
			<!--
			<a href="#" id="upload" class="btn green" onclick="$('#upload_field').click(); return false;">Vali pildifail</a>
			-->
			<input type="file" id="upload_field" />
			<!--<input type="button" id="upload_btn" value="{% trans "Add rephoto" %}" onclick="$('#upload_field').trigger('html5_upload.start');" />-->
			<div id="progress_report">
				<div id="progress_report_name"></div>
				<div id="progress_report_status" style="font-style: italic;"></div>
				<div id="progress_report_bar_container" style="width: 90%; height: 5px;">
					<div id="progress_report_bar" style="background-color: blue; width: 0; height: 100%;"></div>
				</div>
			</div>
			{% endwith %}
		{% else %}
			<div id="facebook-connect">
				<p>{% trans "Rephoto uploading requires connecting your account with Facebook." %}</p>
				<a href="/facebook/login?next={{photo.get_absolute_url}}" class="ir">{% trans "Connect with Facebook" %}</a>
			</div>
		{% endif %}

		<p></p>
		<a href="javascript:void(0);" onclick="uploadCompleted();">{% trans "Close" %}</a>

	</div><!-- #notice -->

	<div id="uploadCompleted" class="notice">
		<h2>{% trans "Thank you!" %}</h2>

		<p>{% trans "Your rephoto has been uploaded." %}</p>
	</div>
</div><!-- #notice-container -->
