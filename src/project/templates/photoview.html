{% extends 'base.html' %}
{% load thumbnail %}

{% block layout %}
<div id="browse">
    <div class="top">

        <h1 class="ir"><a href="/?city={{ photo.city_id }}">Ajapaik</a></h1>

        <ul id="nav">
        </ul>

    </div>

    <div class="single" style="top:7%;">
        <div class="photos clearfix">

            <div class="original photo-item">
                <span class="framed rounded">
                    {% thumbnail photo.image "700x400" as im %}
                    <a href="{{ photo.get_absolute_url }}"><img src="{{ im.url }}" border="0" /></a>
                    {% endthumbnail %}
                </span>
                <div class="tools">
                    <div class="description">
                        <p>{{ photo.description }}</p>
                        <p class="owner">{{ photo.source.name }}</p>
                    </div>
                </div>
            </div><!-- .original -->

            {% thumbnail rephoto.image "700x400" as im %}

            <div class="rephoto photo-item">
                <div class="container">
                    <div class="meta">
                        <div class="content" id="meta_content">
							<p style="margin-left:35px;"> {% if rephoto.date %}{{ rephoto.date|date:"F d, Y" }}{% else %}{{ rephoto.created|date:"F d, Y" }}{% endif %}</p>
							{% if rephoto.user.fb_name %}<p class="owner"><a href="{{ rephoto.user.fb_link }}" target="_blank"><img style="width:30px;height:30px;" src="http://graph.facebook.com/{{ rephoto.user.fb_id }}/picture?type=square" /></a> {{ rephoto.user.fb_name }}</p>{% endif %}
                        </div>
                    </div>
                    <img id="rephoto_img" src="{{ im.url }}" />
                </div>

                <div class="tools">
                    <ul class="thumbs">
                        <li><a href="{{ photo.get_absolute_url }}" class="add-rephoto btn small">Lisa ülepildistus</a></li>

                        {% for rephoto in photo.rephotos.all %}
                        <li class="photo"><a href="{{ rephoto.get_absolute_url }}" title="{% if rephoto.user.fb_name %}{{ rephoto.user.fb_name }}{% endif %}"><img src="{% thumbnail rephoto.image "50x50" crop="center" as thumb %}{{ thumb.url }}{% endthumbnail %}" border="0" /></a></li>
                        {% endfor %}
                    </ul>
                </div>
            </div><!-- .rephoto -->
			
			{% empty %}

			<div class="no-rephoto">
				<script src="{{ MEDIA_URL }}js/jquery.html5_upload.js" type="text/javascript"></script>
				<script type="text/javascript">
				$(function() {
					$("#upload_field").html5_upload({
						autostart: true,
						stopOnFirstError: false,
						url: function(number) {
							return '{% url views.photo_upload photo.pk %}';
							//return prompt(number + " url", "/");
						},
						onBrowserIncompatible: function() {
							$("#upload_field").attr('disabled', 'disabled');
						},
						sendBoundary: window.FormData || $.browser.mozilla,
						onStart: function(event, total) {
							return confirm("Soovid laadida üles " + total + " faili. Jätkan?");
						},
						setName: function(text) {
							$("#progress_report_name").text(text);
						},
						setStatus: function(text) {
							$("#progress_report_status").text(text);
						},
						setProgress: function(val) {
							$("#progress_report_bar").css('width', Math.ceil(val*100)+"%");
						},
						onFinish: function(event, response, name, number, total) {
							uploadCompleted();
						}
					});
				});
				</script>

				<p>Tee samast kohast võimalikult täpne tänapäevane ülepildistus ja lae see siia ajaloolise pildi kõrvale.</p>

				{% if request.user.is_authenticated and request.user.get_profile.fb_id %}
					{% with profile=request.user.get_profile user=request.user %}
					<p>Konto (<a href="{{ profile.fb_link }}" target="_blank">{{ user.get_full_name }}</a>) seotud Facebookiga.<br />Kui see ei ole sina, siis <a href="/logout">vajuta siia</a>.</p>
					<!--
					<a href="#" id="upload" class="btn green" onclick="$('#upload_field').click(); return false;">Vali pildifail</a>
					-->
					<input type="file" multiple="multiple" id="upload_field" />
					<!--<input type="button" id="upload_btn" value="Lae üles" onclick="$('#upload_field').trigger('html5_upload.start');" />-->
					<div id="progress_report">
						<div id="progress_report_name"></div>
						<div id="progress_report_status" style="font-style: italic;"></div>
						<div id="progress_report_bar_container" style="width: 90%; height: 5px;">
							<div id="progress_report_bar" style="background-color: blue; width: 0; height: 100%;"></div>
						</div>
					</div>
					{% endwith %}
				{% else %}
					<div id="facebook-connect" align="center">
						<p>Ülepildistuste lisamiseks ühenda konto kõigepealt Facebookiga.</p>
						<a href="/facebook/login" class="ir">Connect with Facebook</a>
					</div>
				{% endif %}
		
				<div class="tools">
					<ul class="thumbs">
						{% for rephoto in photo.rephotos.all %}
						<li class="photo"><a href="{{ rephoto.get_absolute_url }}" title="{% if rephoto.user.fb_name %}{{ rephoto.user.fb_name }}{% endif %}"><img src="{% thumbnail rephoto.image "50x50" crop="center" as thumb %}{{ thumb.url }}{% endthumbnail %}" /></a></li>
						{% endfor %}
					</ul>
				</div>
				<script>
					$('.photos .original img').load(function() {
						$('.no-rephoto').css('width', $(this).css('width') );
					});
				</script>
			</div>

			{% endthumbnail %}

        </div>

		<div align="center">
			<div>
				<fb:like href="{{ hostname }}{% if rephoto %}{{ rephoto.get_detail_url }}{% else %}{{ photo.get_detail_url }}{% endif %}" send="true" width="450" show_faces="true" action="recommend"></fb:like>
			</div>
			<div>
				<fb:comments href="{{ hostname }}{% if rephoto %}{{ rephoto.get_detail_url }}{% else %}{{ photo.get_detail_url }}{% endif %}" num_posts="3" width="500"></fb:comments>
			</div>
			{% if photo.lat and photo.lon %}
			<a href="/kaart/?city={{ photo.city_id }}"><img src="http://maps.googleapis.com/maps/api/staticmap?sensor=false&size=500x500&scale=2&markers={{ photo.lat }},{{ photo.lon }}" border="0" width="500" /></a>
			{% endif %}
		</div>

    </div>
</div><!-- #browse -->

<script type="text/javascript" src="{{ MEDIA_URL }}js/browse.js"></script>

{% endblock %}