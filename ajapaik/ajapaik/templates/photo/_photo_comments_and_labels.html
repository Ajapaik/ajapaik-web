{% load i18n ajapaik_templatetags comments static %}
<div class="container-fluid text-left">
    <!-- start of dater block -->
    <div class="row my-2" id="ajp-dater-container"></div>
    <!-- end of dater block -->
    <!-- start of albums block -->
    <div class="row pl-3 d-flex flex-row" style="flex-wrap:unset;">
        <span class="material-icons notranslate ajp-photo-modal-album-icon ajp-cursor-default float-left mt-2 pr-3 ajp-icon-36"
            title="{% blocktrans count counter=albums|length %}Picture belongs to album{% plural %}Picture belongs to albums:{% endblocktrans %}">
            {% if a.is_film_still_album %}movie{% else %}collections_bookmark{% endif %}
        </span>
        <div class="d-inline-flex flex-row justify-content-start flex-wrap ajp-text-medium align-items-center">
            {% for a in albums %}
                <div class="mr-2 mt-2 d-flex align-items-center ajp-pebble" data-toggle="popover" onclick="window.albumPhotoLinkClick(event)">
                    <a class="ajp-photo-album-link" data-id="{{ a.id }}" href="#">{{ a.name }}</a>
                </div>
            {% endfor %}
            <a id="ajp-add-to-album-button" class="d-flex flex-row align-items-center mt-2" title="{% trans "Add to album" %}" href="#">
                <div>{% trans 'Add to album' %}</div>
                <span class="material-icons notranslate ajp-text-gray">add_box</span>
            </a>
        </div>
    </div>
    <div>
        <div class="d-inline-flex flex-row justify-content-start flex-wrap ajp-text-medium align-items-center">
            <div id="ajp-probability1"></div>
            <button class="btn btn-success mr-1 ml-1 btn-sm" onclick="postPictureCategory(['{{ photo.id }}'], $('#ajp-probability1').html())">Yes</button>
            <button id="ajp-categorize-scene" type="button" onclick="test()" data-toggle="popover" class="btn btn-danger  mr-1 btn-sm">Propose different category</button>
            <button id="ajp-categorize-scene" type="button" data-toggle="popover" onclick="test()" class="ajp-button" tabindex="0"
                    data-is-categorization-button="true">
                <span class="material-icons notranslate ajp-text-gray ajp-icon-36">category</span>
            </button>
            <div id="ajp-category-confirmation"></div>
        </div>
    </div>

       <button id="ajp-categorize-scene" type="button" data-toggle="popover" class="ajp-button" tabindex="0"
                data-is-categorization-button="true">
            <span class="material-icons notranslate ajp-text-gray ajp-icon-36">category</span>
        </button>

    {% include '_annotations.html' with numberOfColumns=2 %}
    {% if collection_albums.all|length > 0 %}
    <div class="row pl-3 d-flex flex-row" style="flex-wrap:unset;">
        <span class="material-icons notranslate ajp-photo-modal-collection-icon ajp-cursor-default float-left mr-3 mt-2 ajp-icon-36"
            title="{% blocktrans count counter=collection_albums|length %}Picture belongs to collection{% plural %}Picture belongs to collections:{% endblocktrans %}">
            account_balance
        </span>
        <div class="d-inline-flex flex-row justify-content-start flex-wrap ajp-text-medium align-items-center">
            {% for a in collection_albums %}
                <div class="mr-2 mt-2 d-flex align-items-center ajp-pebble" data-toggle="popover" onclick="window.albumPhotoLinkClick(event)">
                    <a class="ajp-photo-album-link" data-id="{{ a.id }}" href="#">{{ a.name }}</a>
                </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    <!-- end of albums block -->
    <!-- start of comment block -->
    <div class="row pt-3" id="ajp-comment-container">
        <div class="col-md-12" id="ajp-comment-list"></div>
        <div class="col-md-12 pl-1" id="ajp-new-comment-form-container">
            {% render_comment_form for photo %}
        </div>
    </div>
    <!-- end of comment block -->
    <!-- start of toolbox block -->
        {% if not request.user_agent.is_pc %}
        <div class="row ajp-dater-hide-when-dater-visible pt-2 w-100">
            {% include '_toolbox.html' with photo=photo sidebar=False flexEnd=False %}
        </div>
    {% endif %}
    <!-- end of toolbox block -->
    {% if request.user.is_superuser %}
        <a id="ajp-photo-modal-discuss" class="no-text-decoration float-right"
            target="_blank"
            title="admin" href="/admin/ajapaik/photo/{{ photo.id }}">
            &Pi;
        </a>
    {% endif %}
</div>

<script src="{% static "js/ajp-picture-category-prediction.js" %}"></script>
<script src="{% static "js/ajp-picture-category-confirmation.js" %}"></script>
<script src="{% static "js/ajp-picture-edit-suggestion.js" %}"></script>
<script src="{% static "js/ajp-category-suggestion.js" %}"></script>
{% block specific_js %}
    <script>

            function updatePhotoSuggestions() {
            fetchPhotoSuggestions().then(function(json) {
                scene = json.scene;
                sceneConsensus = json.scene_consensus;
                viewpointElevation = json.viewpoint_elevation;
                viewpointElevationConsensus = json.viewpoint_elevation_consensus;
                let topLeftButtonClass, topRightButtonClass, bottomLeftButtonClass, bottomMiddleButtonClass,
                    bottomRightButtonClass;
                topLeftButtonClass = topRightButtonClass = bottomLeftButtonClass = bottomMiddleButtonClass = bottomRightButtonClass = 'btn-light';

                let buttonTranslation = 'Confirm';
                let title = gettext('Categorize scene');

                if (scene === 'Interior') {
                    topLeftButtonClass = 'btn-outline-primary';
                } else if (scene === 'Exterior') {
                    topRightButtonClass = 'btn-outline-primary';
                }

                if (scene !== 'Interior' && sceneConsensus === 'Interior') {
                    topLeftButtonClass = 'btn-outline-dark';
                } else if (scene !== 'Exterior' && sceneConsensus === 'Exterior') {
                    topRightButtonClass = 'btn-outline-dark';
                }

                if (viewpointElevation === 'Ground') {
                    bottomLeftButtonClass = 'btn-outline-primary';
                } else if (viewpointElevation === 'Raised') {
                    bottomMiddleButtonClass = 'btn-outline-primary';
                } else if (viewpointElevation === 'Aerial') {
                    bottomRightButtonClass = 'btn-outline-primary';
                }

                if (viewpointElevation !== 'Ground' && viewpointElevationConsensus === 'Ground') {
                    bottomLeftButtonClass = 'btn-outline-dark';
                } else if (viewpointElevation !== 'Raised' && viewpointElevationConsensus === 'Raised') {
                    bottomMiddleButtonClass = 'btn-outline-dark';
                } else if (viewpointElevation !== 'Aerial' && viewpointElevationConsensus === 'Aerial') {
                    bottomRightButtonClass = 'btn-outline-dark';
                }


                if (viewpointElevation === 'undefined' && scene === 'undefined') {
                    buttonTranslation = 'Submit';
                }

                let content = `<div class='d-flex mb-4 justify-content-center'><div class='d-flex' style='flex-direction:column;align-items:center;'><button onclick='clickSceneCategoryButton(this.id);' id='interior-button' class='btn mr-2 ` + topLeftButtonClass + `' style='display:grid;'><span class='material-icons notranslate ajp-icon-48'>hotel</span><span>` + gettext('Interior') + `</span></button></div><div class='d-flex' style='flex-direction:column;align-items:center;'><button onclick='clickSceneCategoryButton(this.id);' id='exterior-button' class='btn ml-2 ` + topRightButtonClass + `' style='display:grid;'><span class='material-icons ajp-icon-48 notranslate'>home</span><span>` + gettext('Exterior') + `</span></button></div></div><div class='d-flex'><div class='d-flex' style='flex-direction:column;align-items:center;'><button onclick='clickViewpointElevationCategoryButton(this.id);' id='ground-button' class='btn mr-2 ` + bottomLeftButtonClass + `' style='display:grid;'><span class='material-icons notranslate ajp-icon-48'>nature_people</span><span>` + gettext('Ground') + `</span></button></div><div class='d-flex' style='flex-direction:column;align-items:center;'><button onclick='clickViewpointElevationCategoryButton(this.id);' id='raised-button' class='btn mr-2 ` + bottomMiddleButtonClass + `' style='display:grid;'><span class='material-icons notranslate ajp-icon-48'>location_city</span><span>` + gettext('Raised') + `</span></button></div><div class='d-flex' style='flex-direction:column;align-items:center;'><button onclick='clickViewpointElevationCategoryButton(this.id);' id='aerial-button' class='btn ml-2 d-grid ` + bottomRightButtonClass + `' style='display:grid;'><span class='material-icons ajp-icon-48 notranslate'>flight</span><span>` + gettext('Aerial') + `</span></button></div></div>`;
                let actionButtonTemplate = `<button id='send-suggestion-button' onclick="submitCategorySuggestion(['{{ photo.id }}'], false);" class='btn btn-success mt-3 w-100' disabled>` + gettext(buttonTranslation) + `</button>`;
                content += actionButtonTemplate;

                let container = $('#ajp-modal-body').size() > 0 ? '#ajp-modal-body' : 'body';

                $('#ajp-categorize-scene').popover({
                    html: true,
                    sanitize: false,
                    trigger: 'manual',
                    container,
                    content,
                    title,
                });
            });
        }

            {#const categorizeScene = $('#ajp-categorize-scene');#}
            {##}
            {#categorizeScene.on('click', function () {#}
            {#    let id = categorizeScene.attr('aria-describedby');#}
            {#    if (id && $('#' + id).length > 0) {#}
            {#        fetchPhotoSuggestions().then(function (json) {#}
            {#            scene = json.scene;#}
            {#            sceneConsensus = json.scene_consensus;#}
            {#            viewpointElevation = json.viewpoint_elevation;#}
            {#            viewpointElevationConsensus = json.viewpoint_elevation_consensus;#}
            {#        });#}
            {#        $('#ajp-categorize-scene').popover('hide');#}
            {#    } else {#}
            {#        $('#ajp-categorize-scene').popover('show');#}
            {#    }#}
            {#});#}


        {#let content = `<div class='d-flex mb-4 justify-content-center'><div class='d-flex' style='flex-direction:column;align-items:center;'><button onclick='clickSceneCategoryButton(this.id);' id='interior-button' class='btn mr-2 ` + topLeftButtonClass + `' style='display:grid;'><span class='material-icons notranslate ajp-icon-48'>hotel</span><span>` + gettext('Interior') + `</span></button></div><div class='d-flex' style='flex-direction:column;align-items:center;'><button onclick='clickSceneCategoryButton(this.id);' id='exterior-button' class='btn ml-2 ` + topRightButtonClass + `' style='display:grid;'><span class='material-icons ajp-icon-48 notranslate'>home</span><span>` + gettext('Exterior') + `</span></button></div></div><div class='d-flex'><div class='d-flex' style='flex-direction:column;align-items:center;'><button onclick='clickViewpointElevationCategoryButton(this.id);' id='ground-button' class='btn mr-2 ` + bottomLeftButtonClass + `' style='display:grid;'><span class='material-icons notranslate ajp-icon-48'>nature_people</span><span>` + gettext('Ground') + `</span></button></div><div class='d-flex' style='flex-direction:column;align-items:center;'><button onclick='clickViewpointElevationCategoryButton(this.id);' id='raised-button' class='btn mr-2 ` + bottomMiddleButtonClass + `' style='display:grid;'><span class='material-icons notranslate ajp-icon-48'>location_city</span><span>` + gettext('Raised') + `</span></button></div><div class='d-flex' style='flex-direction:column;align-items:center;'><button onclick='clickViewpointElevationCategoryButton(this.id);' id='aerial-button' class='btn ml-2 d-grid ` + bottomRightButtonClass + `' style='display:grid;'><span class='material-icons ajp-icon-48 notranslate'>flight</span><span>` + gettext('Aerial') + `</span></button></div></div>`;#}
        {#let actionButtonTemplate = `<button id='send-suggestion-button' onclick="submitCategorySuggestion(['{{ photo.id }}'], false);" class='btn btn-success mt-3 w-100' disabled>` + gettext(buttonTranslation) + `</button>`;#}
        {#content += actionButtonTemplate;#}
        {##}
        {#let container = $('#ajp-modal-body').size() > 0 ? '#ajp-modal-body' : 'body';#}
        {##}
        {#$('#ajp-categorize-scene').popover({#}
        {#    html: true,#}
        {#    sanitize: false,#}
        {#    trigger: 'manual',#}
        {#    container,#}
        {#    content,#}

        function test() {
            console.log("+=+++++")
            const categorizeScene = $('#ajp-categorize-scene');
            let id = categorizeScene.attr('aria-describedby');
            console.log(id);
            if (id && $('#' + id).length > 0) {
                fetchPhotoSuggestions().then(function (json) {
                    scene = json.scene;
                    sceneConsensus = json.scene_consensus;
                    viewpointElevation = json.viewpoint_elevation;
                    viewpointElevationConsensus = json.viewpoint_elevation_consensus;
                });
                $('#ajp-categorize-scene').popover('hide');
            } else {
                console.log("HERE")
                $('#ajp-categorize-scene').popover('show');
            }
        };

        $(document).ready(function () {
            getPictureCategory(['{{ photo.id }}']);

            let container = $('#ajp-modal-body').size() > 0 ? '#ajp-modal-body' : 'body';
            $(".ajp-photo-album-link").each(function() {
                let anchorLink = $(this);
                let requestUrl = api_albumphoto_information.replace('album/0', 'album/' + anchorLink.attr('data-id')).replace('photo/0', 'photo/' + '{{ photo.id }}');
                let request = new Request(
                    requestUrl,
                    {
                        method: 'GET',
                        headers: new Headers()
                    }
                );

                fetch(request)
                .then(function(response) {
                    return response.json();
                }).then(function(data){
                    let popoverContent = $('<div>', { style: 'max-width:240px;' });
                    if (data.profile) {
                        popoverContent.append(gettext('Picture added to album by:') + ' ');
                        popoverContent.append($('<a>', {
                            href: data.profile.profile_url,
                            text: data.profile.name
                        }));
                        popoverContent.append($('<br><br>'));
                    }
                    if (data.photo_count) {
                        let photoCountText = interpolate(ngettext('Album has <em>%(photoCount)s</em> picture', 'Album has <em>%(photoCount)s</em> pictures', data.photo_count), {photoCount: data.photo_count}, true);
                        popoverContent.append(photoCountText);
                    }

                    let viewAlbumButton = createIconButton(
                        gettext("Open album"),
                        'photo_album',
                        gettext('Open album'),
                        function() {
                            window.open('/?album=' + anchorLink.attr('data-id'), '_blank');
                        }
                    )
                    popoverContent.append(viewAlbumButton);

                    anchorLink.popover({
                        html: true,
                        sanitize: false,
                        trigger: 'manual',
                        container,
                        content: popoverContent,
                        title: data.name,
                    })
                });
            });
        })
    </script>
{% endblock %}