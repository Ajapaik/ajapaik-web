{% load i18n ajapaik_templatetags comments static %}
<div class="container-fluid text-left">
    <!-- start of dater block -->
    <div class="row my-2" id="ajp-dater-container"></div>
    <!-- end of dater block -->
    <!-- start of albums block -->

    <div id="ajp-latest-category-scene-div" style="display: none">
        <div class="row">
            <div class="col col-sm-2 d-flex align-items-center">
                <span><b>SCENE:</b></span>
            </div>
            <div class="col col-sm-1 d-flex align-items-center">
                <span id="ajp-latest-category-scene"></span>
            </div>
            <div class="col col-sm-2 align-items-center">
                <button type="submit" id="ajp-confirm-scene-category"
                        class="btn btn-success btn-sm custom-small-button mt-2"
                        onclick="sendCategoryFeedback('{{ photo.id }}', 'scene', $('#ajp-latest-category-scene').text())">
                    <span class="material-icons notranslate">check</span>
                </button>
                <button type="button" id="ajp-reject-scene-category"
                        class="btn btn-danger btn-sm custom-small-button mt-2">
                    <span class="material-icons notranslate">close</span>
                </button>
            </div>
        </div>
    </div>
    <div id="ajp-latest-category-view-point-elevation-div" style="display: none">
        <div class="row">
            <div class="col col-sm-2 d-flex align-items-center">
                <span><b>VIEW POINT ELEVATION:</b></span>
            </div>
            <div class="col col-sm-1 d-flex align-items-center">
                <span id="ajp-latest-category-view-point-elevation"></span>
            </div>
            <div class="col col-sm-2 align-items-center">
                <button type="submit" id="ajp-confirm-view-point-elevation-category"
                        class="btn btn-success btn-sm custom-small-button mt-2"
                        onclick="sendCategoryFeedback('{{ photo.id }}', 'view-point-elevation', $('#ajp-latest-category-view-point-elevation').text())">
                    <span class="material-icons notranslate">check</span>
                </button>
                <button type="button" id="ajp-reject-view-point-elevation-category"
                        class="btn btn-danger btn-sm custom-small-button mt-2">
                    <span class="material-icons notranslate">close</span>
                </button>
            </div>
        </div>
    </div>

    <div class="row pl-3 d-flex flex-row" style="flex-wrap:unset;">
        <span class="material-icons notranslate ajp-photo-modal-album-icon ajp-cursor-default float-left mt-2 pr-3 ajp-icon-36"
            title="{% blocktrans count counter=albums|length %}Picture belongs to album{% plural %}Picture belongs to albums:{% endblocktrans %}">
            {% if a.is_film_still_album %}movie{% else %}collections_bookmark{% endif %}
        </span>
        <div class="d-inline-flex flex-row justify-content-start flex-wrap ajp-text-medium align-items-center">
            {% for a in albums %}
                <div class="mr-2 mt-2 d-flex align-items-center ajp-pebble" data-toggle="popover" onclick="window.albumPhotoLinkClick(event)">
                    <a class="ajp-photo-album-link" data-id="{{ a.id }}" href="#">{{ a.name }}</a>
                </div>
            {% endfor %}
            <a id="ajp-add-to-album-button" class="d-flex flex-row align-items-center mt-2" title="{% trans "Add to album" %}" href="#">
                <div>{% trans 'Add to album' %}</div>
                <span class="material-icons notranslate ajp-text-gray">add_box</span>
            </a>
        </div>
    </div>
    {% include '_annotations.html' with numberOfColumns=2 %}
    {% if collection_albums.all|length > 0 %}
    <div class="row pl-3 d-flex flex-row" style="flex-wrap:unset;">
        <span class="material-icons notranslate ajp-photo-modal-collection-icon ajp-cursor-default float-left mr-3 mt-2 ajp-icon-36"
            title="{% blocktrans count counter=collection_albums|length %}Picture belongs to collection{% plural %}Picture belongs to collections:{% endblocktrans %}">
            account_balance
        </span>
        <div class="d-inline-flex flex-row justify-content-start flex-wrap ajp-text-medium align-items-center">
            {% for a in collection_albums %}
                <div class="mr-2 mt-2 d-flex align-items-center ajp-pebble" data-toggle="popover" onclick="window.albumPhotoLinkClick(event)">
                    <a class="ajp-photo-album-link" data-id="{{ a.id }}" href="#">{{ a.name }}</a>
                </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    <!-- end of albums block -->
    <!-- start of comment block -->
    <div class="row pt-3" id="ajp-comment-container">
        <div class="col-md-12" id="ajp-comment-list"></div>
        <div class="col-md-12 pl-1" id="ajp-new-comment-form-container">
            {% render_comment_form for photo %}
        </div>
    </div>
    <!-- end of comment block -->
    <!-- start of toolbox block -->
        {% if not request.user_agent.is_pc %}
        <div class="row ajp-dater-hide-when-dater-visible pt-2 w-100">
            {% include '_toolbox.html' with photo=photo sidebar=False flexEnd=False %}
        </div>
    {% endif %}
    <!-- end of toolbox block -->
    {% if request.user.is_superuser %}
        <a id="ajp-photo-modal-discuss" class="no-text-decoration float-right"
            target="_blank"
            title="admin" href="/admin/ajapaik/photo/{{ photo.id }}">
            &Pi;
        </a>
    {% endif %}
</div>

<script src="{% static "js/ajp-picture-category-retrival.js" %}"></script>
{% block specific_js %}
    <script>
        $(document).ready(function () {

            let sceneFeedbackView = `
                  <div style='width: 150px'>
                    <button type='button' class='btn btn-light btn-sm c mr-2' id='interior-alternative' onclick="enable('scene', 'interior')">
                      <span class='material-icons notranslate ajp-icon-36'>hotel</span><br>Interior
                    </button>
                    <button type='button' class='btn btn-light btn-sm' id='exterior-alternative' onclick="enable('scene', 'exterior')">
                      <span class='material-icons notranslate ajp-icon-36'>home</span><br>Exterior
                    </button>
                    <button id='send-suggestion-button-scene' class='btn btn-success mt-3 w-100' disabled onclick="sendAlternativeCategoryConfirmation({{ photo.id }})">Confirm</button>
                  </div>`;

            let viewPointElevationFeedbackView = `
                  <div style='width: 200px'>
                    <button type='button' class='btn btn-light btn-sm c mr-2' id='ground-alternative' onclick="enable('view-point-elevation', 'ground')">
                      <span class='material-icons notranslate ajp-icon-36'>nature_people</span><br>Ground
                    </button>
                    <button type='button' class='btn btn-light btn-sm' id='raised-alternative' onclick="enable('view-point-elevation', 'raised')">
                      <span class='material-icons notranslate ajp-icon-36'>location_city</span><br>Raised
                    </button>
                    <button type='button' class='btn btn-light btn-sm' id='aerial-alternative' onclick="enable('view-point-elevation', 'aerial')">
                      <span class='material-icons notranslate ajp-icon-36'>flight</span><br>Aerial
                    </button>
                    <button id='send-suggestion-button-view-point-elevation' class='btn btn-success mt-3 w-100' disabled onclick="sendAlternativeCategoryConfirmation({{ photo.id }})">Confirm</button>
                  </div>`;

              $('#ajp-reject-scene-category').popover({
                html: true,
                sanitize: false,
                trigger: 'manual',
                content: sceneFeedbackView,
                title: 'Suggest different',
              });

            $('#ajp-reject-view-point-elevation-category').popover({
                html: true,
                sanitize: false,
                trigger: 'manual',
                content: viewPointElevationFeedbackView,
                title: 'Suggest different',
            });

            $('#ajp-reject-scene-category').on('click', function () {
                $('#ajp-reject-view-point-elevation-category').popover('hide');
                $(this).popover('toggle');
            });

            $('#ajp-reject-view-point-elevation-category').on('click', function () {
                $('#ajp-reject-scene-category').popover('hide');
                $(this).popover('toggle');
            });

            $(document).on('click', function (event) {
                const target = $(event.target);
                if (!target.is('#ajp-reject-scene-category') && !target.closest('.popover').length) {
                    $('#ajp-reject-scene-category').popover('hide');
                }
                if (!target.is('#ajp-reject-view-point-elevation-category') && !target.closest('.popover').length) {
                    $('#ajp-reject-view-point-elevation-category').popover('hide');
                }
            });

            getImageCategory('{{ photo.id }}', function (categoryMap) {
                if (categoryMap.hasOwnProperty('scene')) {
                    $("#ajp-latest-category-scene").html(categoryMap["scene"]);
                    $("#ajp-latest-category-scene-div").show();
                }
                if (categoryMap.hasOwnProperty('viewpoint_elevation')) {
                    $("#ajp-latest-category-view-point-elevation").html(categoryMap["viewpoint_elevation"]);
                    $("#ajp-latest-category-view-point-elevation-div").show();
                }
            });


            let container = $('#ajp-modal-body').size() > 0 ? '#ajp-modal-body' : 'body';
            $(".ajp-photo-album-link").each(function() {
                let anchorLink = $(this);
                let requestUrl = api_albumphoto_information.replace('album/0', 'album/' + anchorLink.attr('data-id')).replace('photo/0', 'photo/' + '{{ photo.id }}');
                let request = new Request(
                    requestUrl,
                    {
                        method: 'GET',
                        headers: new Headers()
                    }
                );

                fetch(request)
                .then(function(response) {
                    return response.json();
                }).then(function(data){
                    let popoverContent = $('<div>', { style: 'max-width:240px;' });
                    if (data.profile) {
                        popoverContent.append(gettext('Picture added to album by:') + ' ');
                        popoverContent.append($('<a>', {
                            href: data.profile.profile_url,
                            text: data.profile.name
                        }));
                        popoverContent.append($('<br><br>'));
                    }
                    if (data.photo_count) {
                        let photoCountText = interpolate(ngettext('Album has <em>%(photoCount)s</em> picture', 'Album has <em>%(photoCount)s</em> pictures', data.photo_count), {photoCount: data.photo_count}, true);
                        popoverContent.append(photoCountText);
                    }

                    let viewAlbumButton = createIconButton(
                        gettext("Open album"),
                        'photo_album',
                        gettext('Open album'),
                        function() {
                            window.open('/?album=' + anchorLink.attr('data-id'), '_blank');
                        }
                    )
                    popoverContent.append(viewAlbumButton);

                    anchorLink.popover({
                        html: true,
                        sanitize: false,
                        trigger: 'manual',
                        container,
                        content: popoverContent,
                        title: data.name,
                    })
                });
            });
        })

        function enable(categoryClass, category) {
            $('#interior-alternative').removeClass('active');
            $('#exterior-alternative').removeClass('active');
            $('#send-suggestion-button-scene').prop('disabled', true);

            $('#ground-alternative').removeClass('active');
            $('#raised-alternative').removeClass('active');
            $('#aerial-alternative').removeClass('active');
            $('#send-suggestion-button-view-point-elevation').prop('disabled', true);

            if (categoryClass === "scene") {
                $('#send-suggestion-button-scene').prop('disabled', false);
                if (category === "interior") {
                    $('#interior-alternative').addClass('active');
                } else {
                    $('#exterior-alternative').addClass('active');
                }
            }
            if (categoryClass === "view-point-elevation") {
                $('#send-suggestion-button-view-point-elevation').prop('disabled', false);
                if (category === "ground") {
                    $('#ground-alternative').addClass('active');
                } else if (category === "raised") {
                    $('#raised-alternative').addClass('active');
                } else {
                    $('#aerial-alternative').addClass('active');
                }
            }
        }

        function sendAlternativeCategoryConfirmation(photoId) {
            if ($('#interior-alternative').hasClass('active')) {
                sendCategoryFeedback(photoId, "scene", "interior")
            } else if ($('#exterior-alternative').hasClass('active')) {
                sendCategoryFeedback(photoId, "scene", "exterior")
            } else if ($('#ground-alternative').hasClass('active')) {
                sendCategoryFeedback(photoId, "view-point-elevation", "ground")
            } else if ($('#raised-alternative').hasClass('active')) {
                sendCategoryFeedback(photoId, "view-point-elevation", "raised")
            } else if ($('#aerial-alternative').hasClass('active')) {
                sendCategoryFeedback(photoId, "view-point-elevation", "aerial")
            }
            $('#ajp-reject-scene-category').popover('hide');
            $('#ajp-reject-view-point-elevation-category').popover('hide');
        }
    </script>
{% endblock %}