{% load i18n %}
<div class="{% if is_photo_modal %}ajp-mt-1{% else %}row ajp-height-48 mt-2{% endif %}">
    <a data-id="{{ photo.id }}" class="float-left"
        title="{% trans "Pick the shooting location!" %}" href="/geotag/?photo={{ photo.id }}" target="_blank"
        rel="nofollow">
        <i class="material-icons notranslate ajp-text-gray ajp-icon-48">add_location</i>
    </a>
    <a id="ajp-start-dating-button" data-id="{{ photo.id }}" class="float-left"
        title="{% trans "Date this image" %}" href="#">
        <i class="material-icons notranslate ajp-text-gray ajp-icon-48">event</i>
        <span id="ajp-photoview-datings-count" class="badge">{{ datings_count }}</span>
    </a>
    <a title="{% trans "Add rephoto" %}" data-id="{{ photo.id }}" id="ajp-add-rephoto-button" href="#" class="float-left{% if not is_photo_modal %} ml-2{% endif %}">
        <i class="material-icons notranslate ajp-text-gray ajp-icon-48">add_a_photo</i>
    </a>
    <button title="{% trans "Tag a new face/object - clicking this button will enable you to draw an object/face rectangle on the main image" %}"
        id="mark-object-button"
        class="float-left"
    >
        <i class="material-icons notranslate ajp-text-gray ajp-icon-48">format_shapes</i>
    </button>
    </a>
    <div class="dropdown float-left">
        <a id="ajp-sharing-dropdown-button" href="#" role="button" title="{% trans "Share" %}"
            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <i class="material-icons notranslate ajp-text-gray ajp-icon-48">share</i>
        </a>
        <ul class="dropdown-menu" role="menu" aria-labelledby="ajp-sharing-dropdown-button">
            <li role="presentation" class="disabled-link">
                <div role="menuitem" tabindex="-1" id="ajp-grab-link">
                    <a href="{{ hostname }}{% if is_photo_modal %}{{ photo.get_detail_url }}{% elif rephoto %}{{ rephoto.get_absolute_url }}{% else %}{{ photo.get_absolute_url }}{% endif %}">
                        {{ hostname }}{% if is_photo_modal %}{{ photo.get_detail_url }}{% elif rephoto %}{{ rephoto.get_absolute_url }}{% else %}{{ photo.get_absolute_url }}{% endif %}
                    </a>
                </div>
            </li>
        </ul>
    </div>
    <button id="ajp-categorize-scene-button" type="button" data-toggle="popover" data-modal="false">
        <i class="material-icons notranslate ajp-text-gray ajp-icon-48">category</i>
    </button>
    <button id="ajp-transcribe-button" data-id="{{ photo.id }}" onclick="window.transcriberButtonClick(this);"
        title="{% trans "Transcribe this image" %}" href="#">
        <i class="material-icons notranslate ajp-text-gray ajp-icon-48">text_fields</i>
        <span id="ajp-photoview-transcriptions-count" class="badge"></span>
    </a>
</div>
{% block specific_js %}
    <script>
        var photoSceneUrl = "{% url 'api_photo_suggestion' %}";
        var scene = undefined;
        var scene_consensus = undefined;
        var viewpointElevation = undefined;
        var viewpointElevation_consensus = undefined;

        async function handleErrors(response) {
            const data = await response.json();
            if (data.error) {
                throw data.error;
            }
            return data.message;
        }

        function submitCategorySuggestion() {
            return fetch(photoSceneUrl, {
                method: 'POST',
                beforeSend : function(xhr) {
                    xhr.setRequestHeader("X-CSRFTOKEN", window.docCookies.getItem('csrftoken'));
                },
                headers: {
                    'Content-Type': 'application/json',

                },
                body: JSON.stringify({
                    photoId: '{{ photo.id }}',
                    scene,
                    viewpointElevation
                })
            
            })
            .then(handleErrors)
            .then(function(message) {
                updatePhotoScene();
                $('#ajp-categorize-scene-button').not(this).popover('hide');
                $('#ajp-categorize-scene-button').popover('dispose');
                $.notify(message, {type: 'success'});
            }).catch((error) => {
                $.notify(error, {type: 'danger'});
            });
        };

        function clickViewpointElevationCategoryButton(buttonId) {
            $('#send-suggestion-button').prop("disabled", false);

            let otherButtonIds = [];

            if (buttonId === 'aerial-button') {
                viewpointElevation = 'Aerial';
            } else if (buttonId === 'raised-button') {
                viewpointElevation = 'Raised'
            } else if (buttonId === 'ground-button') {
                viewpointElevation = 'Ground';
            }
            
            if (viewpointElevation === 'Aerial') {
                otherButtonIds = ['#ground-button', '#raised-button'];
            } else if (viewpointElevation === 'Raised') {
                otherButtonIds = ['#ground-button', '#aerial-button'];
            } else if (viewpointElevation === 'Ground') {
                otherButtonIds = ['#raised-button', '#aerial-button'];
            }

            otherButtonIds.forEach(function(id) {
                if(!$(id).hasClass('btn-outline-primary')) {
                    $(id).addClass('btn-light');
                }
                if($(id).hasClass('btn-outline-primary')) {
                    $(id).removeClass('btn-outline-primary');
                }
                if($(id).hasClass('btn-outline-dark')) {
                    $(id).removeClass('btn-outline-dark');
                }
            });

            $('#' + buttonId).addClass('btn-outline-primary');
            $('#' + buttonId).removeClass('btn-outline-dark');
            $('#' + buttonId).removeClass('btn-light');
        };

        function clickSceneCategoryButton(buttonId) {
            $('#send-suggestion-button').prop("disabled", false);

            scene = buttonId === 'interior-button'
                ? 'Interior'
                : 'Exterior';
            let otherButtonId = scene === 'Interior'
                ? '#exterior-button'
                : '#interior-button';

            if(!$(otherButtonId).hasClass('btn-light')) {
                $(otherButtonId).addClass('btn-light');
            }
    
            if ($(otherButtonId).hasClass('btn-outline-primary')) {
                $(otherButtonId).removeClass('btn-outline-primary');
            }

            if ($(otherButtonId).hasClass('btn-outline-dark')) {
                $(otherButtonId).removeClass('btn-outline-dark');
            }

            $('#' + buttonId).addClass('btn-outline-primary');
            $('#' + buttonId).removeClass('btn-outline-dark');
            $('#' + buttonId).removeClass('btn-light');
        };

        function fetchPhotoSuggestion() {
            return fetch(photoSceneUrl + '{{ photo.id }}' + '/').then(function(response) {
                return response.json();
            }).then(function(json) {
                return json;
            });
        }

        function updatePhotoScene() {
            fetchPhotoSuggestion().then(function(json) {
                    scene = json.scene;
                    scene_consensus = json.scene_consensus;
                    viewpointElevation = json.viewpoint_elevation;
                    viewpointElevation_consensus = json.viewpoint_elevation_consensus;
                    let topLeftButtonClass, topRightButtonClass, bottomLeftButtonClass, bottomMiddleButtonClass, bottomRightButtonClass;
                    topLeftButtonClass = topRightButtonClass = bottomLeftButtonClass = bottomMiddleButtonClass = bottomRightButtonClass = 'btn-light';

                    let buttonTranslation = 'Confirm';
                    let title = gettext('Categorize scene');

                    if (scene === 'Interior') {
                        topLeftButtonClass = 'btn-outline-primary';
                    } else if (scene === 'Exterior') {
                        topRightButtonClass = 'btn-outline-primary';
                    }

                    if (scene !== 'Interior' && scene_consensus === 'Interior') {
                        topLeftButtonClass = 'btn-outline-dark';
                    } else if (scene !== 'Exterior' && scene_consensus === 'Exterior') {
                        topRightButtonClass = 'btn-outline-dark';
                    }

                    if (viewpointElevation === 'Ground') {
                        bottomLeftButtonClass = 'btn-outline-primary';
                    } else if (viewpointElevation === 'Raised') {
                        bottomMiddleButtonClass = 'btn-outline-primary';
                    } else if (viewpointElevation === 'Aerial') {
                        bottomRightButtonClass = 'btn-outline-primary';
                    }

                    if (viewpointElevation !== 'Ground' && viewpointElevation_consensus === 'Ground') {
                        bottomLeftButtonClass = 'btn-outline-dark';
                    } else if (viewpointElevation !== 'Raised' && viewpointElevation_consensus === 'Raised') {
                        bottomMiddleButtonClass = 'btn-outline-dark';
                    } else if (viewpointElevation !== 'Aerial'  && viewpointElevation_consensus === 'Aerial') {
                        bottomRightButtonClass = 'btn-outline-dark';
                    }


                    if (viewpointElevation === 'undefined' && scene === 'undefined') {
                        buttonTranslation = 'Submit';
                    }

                    let content = `<div class='d-flex mb-4' style='justify-content:center;'><div class='d-flex' style='flex-direction:column;align-items:center;'><button onclick='clickSceneCategoryButton(this.id);' id='interior-button' class='btn mr-2 ` + topLeftButtonClass +`' style='display:grid;'><i class='material-icons notranslate ajp-icon-48'>hotel</i><span>` + gettext('Interior') + `</span></button></div><div class='d-flex' style='flex-direction:column;align-items:center;'><button onclick='clickSceneCategoryButton(this.id);' id='exterior-button' class='btn ml-2 ` + topRightButtonClass +`' style='display:grid;'><i class='material-icons ajp-icon-48 notranslate'>home</i><span>` + gettext('Exterior') + `</span></button></div></div><div class='d-flex'><div class='d-flex' style='flex-direction:column;align-items:center;'><button onclick='clickViewpointElevationCategoryButton(this.id);' id='ground-button' class='btn mr-2 ` + bottomLeftButtonClass +`' style='display:grid;'><i class='material-icons notranslate ajp-icon-48'>nature_people</i><span>` + gettext('Ground') + `</span></button></div><div class='d-flex' style='flex-direction:column;align-items:center;'><button onclick='clickViewpointElevationCategoryButton(this.id);' id='raised-button' class='btn mr-2 ` + bottomMiddleButtonClass +`' style='display:grid;'><i class='material-icons notranslate ajp-icon-48'>location_city</i><span>` + gettext('Raised') + `</span></button></div><div class='d-flex' style='flex-direction:column;align-items:center;'><button onclick='clickViewpointElevationCategoryButton(this.id);' id='aerial-button' class='btn ml-2 d-grid ` + bottomRightButtonClass +`' style='display:grid;'><i class='material-icons ajp-icon-48 notranslate'>flight</i><span>` + gettext('Aerial') + `</span></button></div></div>`;
                    let actionButtonTemplate = `<button id='send-suggestion-button' onclick='submitCategorySuggestion();' class='btn btn-success mt-3 w-100' disabled>` + gettext(buttonTranslation) + `</button>`;
                    content += actionButtonTemplate;

                    let container = $('#ajp-modal-body').size() > 0 ? '#ajp-modal-body' : 'body';

                    $('#ajp-categorize-scene-button').popover({
                        html: true,
                        sanitize: false,
                        container,
                        content,
                        title
                    });
            });
        };

        $('#ajp-start-dating-button').click(function (e) {
            e.preventDefault();
            if (window.isFrontpage) {
                _gaq.push(['_trackEvent', 'Gallery', 'Photo modal dater photo click']);
            } else if (window.isMapview) {
                _gaq.push(['_trackEvent', 'Map', 'Photo modal dater photo click']);
            } else if (window.isGame) {
                _gaq.push(['_trackEvent', 'Game', 'Photo modal dater photo click']);
            } else {
                _gaq.push(['_trackEvent', 'Game', 'Photo view dater photo click']);
            }
            if ($('#ajp-dater-container').is(':visible')) {
                window.stopDater();
                window.reportCloseDater();
            } else {
                window.startDater($(this).data('id'));
                window.reportDaterOpen();
            }
        });

        window.updateDatings = function () {
            $.ajax({
                url: "{% url 'get_datings' photo.id %}",
                success: function (result) {
                    $('#ajp-dater-container').data('AjapaikDater').buildPreviousDatingsDiv(result.datings);
                    $('#ajp-modal-start-dating-button').find('.badge').html(result.datings.length);
                    $('#ajp-photoview-start-dating-button').find('.badge').html(result.datings.length);
                    window.updateLeaderboard();
                    $('#ajp-dater-input').val(null);
                    $('#ajp-dater-comment').val(null);
                }
            });
        };

        $('#mark-object-button').click(function (e) {
            ObjectTagger.toggleCropping();
        });

        
        window.startDater = function (photoId) {
            $('.ajp-dater-hide-when-dater-visible').hide();
            $('#ajp-dater-container').show().data('AjapaikDater').initializeDaterState({
                photoId: photoId,
                previousDatings: window.previousDatings
            });
            $('.ajp-close-rephoto-overlay-button').click();
        };

        window.stopDater = function () {
            $('.ajp-dater-hide-when-dater-visible').show();
            $('#ajp-dater-input').val(null);
            $('#ajp-dater-comment').val(null);
            $('#ajp-dater-feedback').empty();
            $('#ajp-dater-container').hide();
            $('#ajp-dater-feedback-card').hide();
        };


        window.openPhotoUploadModal = function () {
            if (window.currentlyOpenPhotoId) {
                $.ajax({
                    cache: false,
                    url: window.photoUploadModalURL + window.currentlyOpenPhotoId + '/',
                    success: function (result) {
                        var rephotoUploadModal = $('#ajp-rephoto-upload-modal');
                        rephotoUploadModal.data('bs.modal', null);
                        rephotoUploadModal.html(result).modal();
                    }
                });
            }
        };

        $(document).ready(function () {
            updatePhotoScene();
            var rephotoUploadModal = $('#ajp-rephoto-upload-modal'); 
            $(document).on('click', '#ajp-add-rephoto-button', function (e) {
                e.preventDefault();
                $.ajax({
                    cache: false,
                    url: window.photoUploadModalURL + ($(this).data('id')) + '/',
                    success: function (result) {
                        rephotoUploadModal.data('bs.modal', null);
                        rephotoUploadModal.html(result).modal();
                    }
                });
            });
        });
    </script>
{% endblock %}