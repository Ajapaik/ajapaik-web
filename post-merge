#!/bin/bash
if [[ "$(cat /var/garage/run/selected)" == "B" ]]; then
    RUNNING="B"
    STARTING="A"
else
    RUNNING="A"
    STARTING="B"
fi

unset GIT_DIR
cd /var/garage/rephoto.$RUNNING

echo "* Reset server repository"
git reset --hard
git pull origin master || exit 1

echo "* Perform database migrations"
/opt/python27/bin/python2.7 manage.py migrate --settings=ajapaik.settings || exit 1
echo "* Deploy static files"
/opt/python27/bin/python2.7 manage.py collectstatic --noinput --settings=ajapaik.settings || exit 1
echo "* Compress static files"
/opt/python27/bin/python2.7 manage.py compress --settings=ajapaik.settings || exit 1

echo "* Restart app"
sudo supervisorctl restart ajapaik_ee.$STARTING

echo "* Reload webserver"
sudo /usr/local/bin/ajapaik-switch $STARTING