{% extends "base_bootstrap.html" %}
{% load i18n compress %}

{% block header %}
    {% include "_header.html" %}
{% endblock %}

{% block layout %}
    <div class="container" id="ajapaik-curator-container">
        <div class="col-xs-12">
            {% if request.user.is_authenticated and request.user.profile.fb_id %}
                {% with profile=request.user.profile user=request.user %}
                    <div class="row"><p>{% trans "User" %} <b>{{ user.get_full_name }}</b>. <a href='/logout' id='logout-button'>{% trans "Log out" %}</a>.</p></div>
                {% endwith %}
                <div class="modal fade" id="ajapaik-choose-albums-modal">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                                <h4 class="modal-title">{% trans "Choose albums" %}</h4>
                            </div>
                            <div class="modal-body">
                                {% for a in selectable_albums %}
                                    <div class="row">
                                        <div class="col-xs-12">
                                            <div class="input-group">
                                                    <span class="input-group-addon">
                                                        <input name="album_list[]" type="checkbox" value="{{ a.id }}" data-album-name="{{ a.name }}">
                                                    </span>
                                                <label class="form-control">{{ a.name }}</label>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-success" id="ajapaik-curator-add-album-button">
                                    <i class="glyphicon glyphicon-plus"></i>{% trans "Add" %}
                                </button>
                                <button type="button" class="btn btn-default" data-dismiss="modal">
                                    {% trans "Close" %}
                                </button>
                                <button type="button" class="btn btn-primary" id="ajapaik-curator-confirm-album-selection-button">
                                    {% trans "Save" %}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal fade" id="ajapaik-choose-area-modal">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                                <h4 class="modal-title">{% trans "Choose area" %}</h4>
                            </div>
                            <div class="modal-body">
                                {% for a in selectable_areas %}
                                    <div class="row">
                                        <div class="col-xs-12">
                                            <div class="input-group">
                                                    <span class="input-group-addon">
                                                        <input name="area" type="radio" value="{{ a.id }}" data-area-name="{{ a.name }}">
                                                    </span>
                                                <label class="form-control">{{ a.name }}</label>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-success" id="ajapaik-curator-add-area-button">
                                    <i class="glyphicon glyphicon-plus"></i>{% trans "Add" %}
                                </button>
                                <button type="button" class="btn btn-default" data-dismiss="modal">
                                    {% trans "Close" %}
                                </button>
                                <button type="button" class="btn btn-primary" id="ajapaik-curator-confirm-area-selection-button">
                                    {% trans "Save" %}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal fade" id="ajapaik-create-album-modal">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                        aria-hidden="true">&times;</span></button>
                                <h4 class="modal-title">{% trans "Create a new album" %}</h4>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-xs-12" id="ajapaik-curator-add-album-error"
                                         style="display: none;">
                                        <div class="alert alert-danger" role="alert">
                                            <span class="glyphicon glyphicon-exclamation-sign"
                                                  aria-hidden="true"></span>
                                            {% trans "Error" %}
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-xs-12">
                                        <div class="input-group">
                                            <span class="input-group-addon">
                                                <label for="ajapaik-curator-add-album-name">{% trans "New album name" %}&nbsp;*</label>
                                            </span>
                                            <input class="form-control" type="text"
                                                   id="ajapaik-curator-add-album-name">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-xs-12">
                                        <div class="input-group">
                                            <span class="input-group-addon">
                                                <label for="ajapaik-curator-add-album-description">{% trans "New album description" %}</label>
                                            </span>
                                            <textarea class="form-control"
                                                      id="ajapaik-curator-add-album-description"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default"
                                        data-dismiss="modal">{% trans "Close" %}</button>
                                <button type="button" class="btn btn-primary"
                                        id="ajapaik-curator-save-new-album-button">{% trans "Save" %}</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal fade" id="ajapaik-create-area-modal">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                        aria-hidden="true">&times;</span></button>
                                <h4 class="modal-title">{% trans "Create a new area" %}</h4>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-xs-12" id="ajapaik-curator-add-area-error"
                                         style="display: none;">
                                        <div class="alert alert-danger" role="alert">
                                            <span class="glyphicon glyphicon-exclamation-sign"
                                                  aria-hidden="true"></span>
                                            {% trans "Error" %}
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-xs-12">
                                        <div class="input-group">
                                            <span class="input-group-addon">
                                                <label for="ajapaik-curator-add-area-name">{% trans "New area name" %}&nbsp;*</label>
                                            </span>
                                            <input class="form-control" type="text"
                                                   id="ajapaik-curator-add-area-name">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-xs-12">
                                        <div class="input-group">
                                            <span class="input-group-addon">
                                                <label for="ajapaik-curator-add-area-lat">{% trans "New area latitude" %}</label>
                                            </span>
                                            <input class="form-control" type="number"
                                                   id="ajapaik-curator-add-area-lat">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-xs-12">
                                        <div class="input-group">
                                            <span class="input-group-addon">
                                                <label for="ajapaik-curator-add-area-lon">{% trans "New area longitude" %}</label>
                                            </span>
                                            <input class="form-control" type="number"
                                                   id="ajapaik-curator-add-area-lon">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default"
                                        data-dismiss="modal">{% trans "Close" %}</button>
                                <button type="button" class="btn btn-primary"
                                        id="ajapaik-curator-save-new-area-button">{% trans "Save" %}</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-2">
                        <input type="text" class="form-control" id="ajapaik-curator-full-search" placeholder="{% trans "Full search" %}">
                    </div>
                    <div class="col-xs-2">
                        <button type="button" class="btn btn-primary btn-block" id="ajapaik-curator-search-button">
                            {% trans "Search!" %}
                        </button>
                    </div>
                    <div class="col-xs-2">
                        <button type="button" class="btn btn-primary btn-block" id="ajapaik-curator-open-area-modal">
                            {% trans "Choose area" %}
                        </button>
                    </div>
                    <div class="col-xs-2">
                        <button type="button" class="btn btn-primary btn-block" id="ajapaik-curator-open-album-modal">
                            {% trans "Choose albums" %}
                        </button>
                    </div>
                    <div class="col-xs-2">
                        <button type="button" class="btn btn-primary btn-block" id="ajapaik-curator-clear-selection">
                            {% trans "Clear selection" %}
                        </button>
                    </div>
                    <div class="col-xs-2">
                        <button type="button" class="btn btn-primary btn-block ajapaik-curator-load-more">
                            {% trans "Load more" %}
                        </button>
                    </div>
                </div>
                <div class="row" id="ajapaik-curator-result-count-row">
                    <span id="ajapaik-curator-result-count">{% trans "Results:" %}&nbsp;<span>0</span></span>
                </div>
                <div class="row">
                    <span id="ajapaik-curator-destination-album">{% trans "Selected albums:" %}&nbsp;<span>{{ album.name }}</span></span>
                </div>
                <div class="row">
                    <span id="ajapaik-curator-destination-area">{% trans "Selected area:" %}&nbsp;<span>{{ area.name }}</span></span>
                </div>
                <div role="tabpanel" id="ajapaik-curator-tabpanel">
                    <ul class="nav nav-tabs" role="tablist" id="ajapaik-curator-tabs">
                        <li role="presentation" class="active">
                            <a href="#ajapaik-curator-results-tab" aria-controls="ajapaik-curator-results-tab" role="tab" data-toggle="tab">{% trans "Search results" %}</a>
                        </li>
                        <li role="presentation">
                            <a href="#ajapaik-curator-selection-tab" aria-controls="ajapaik-curator-selection-tab" role="tab" data-toggle="tab">{% trans "Selection" %}</a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div role="tabpanel" class="tab-pane active" id="ajapaik-curator-results-tab">
                            <div class="row">
                                <div class="col-xs-12" id="ajapaik-curator-search-results"></div>
                            </div>
                            <div class="row">
                                <div class="col-xs-offset-10 col-xs-2">
                                    <button type="button" class="btn btn-primary btn-block ajapaik-curator-load-more">
                                        {% trans "Load more" %}
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div role="tabpanel" class="tab-pane" id="ajapaik-curator-selection-tab">
                            <div class="row">
                                <div class="col-xs-12" id="ajapaik-curator-selection"></div>
                            </div>
                        </div>
                    </div>
                </div>
            {% else %}
                <div id="facebook-connect">
                    <p>{% trans "Curating requires connecting your account with Facebook." %}</p>
                    <a href="/facebook/login" class="ir">{% trans "Connect with Facebook" %}</a>
                </div>
            {% endif %}
        </div>
    </div>
{% endblock layout %}
{% block specific_js %}
{% compress js %}
    <script src="{{ STATIC_URL }}js/ajapaik-common.js"></script>
    <script src="{{ STATIC_URL }}libs/jQuery-File-Upload-9.9.2/js/tmpl.min.js"></script>
{% endcompress %}
<script>
    $(function () {
        'use strict';
        $(document).ready(function () {
            if (window.getQueryParameterByName('albumChoiceOpen')) {
                $('#ajapaik-curator-open-album-modal').click();
            }
            if (window.getQueryParameterByName('areaChoiceOpen')) {
                $('#ajapaik-curator-open-area-modal').click();
            }
            $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
                if ($(e.target).attr('href') === '#ajapaik-curator-selection-tab') {
                    buildSelectionDiv();
                }
            })
        });
        var selectedAlbums = [[{{ album.id}}]],
            selectedArea = '{{ area.id }}',
            selectedAreaName = '{{ area.name }}',
            resultCount = 0,
            url = '/curator_search/',
            start = 200,
            resultIds = [],
            fullResultSet = {},
            selectedResults = {},
            selectionDiv = $('#ajapaik-curator-selection'),
            resultDiv = $('#ajapaik-curator-search-results');
        $(document).on('click', '#ajapaik-curator-open-album-modal', function () {
            $('#ajapaik-choose-albums-modal').modal().on('shown.bs.modal', function () {
                $(window).resize(window.adjustModalMaxHeightAndPosition).trigger('resize');
                window.History.replaceState(null, '{{ title }}', '{% url 'project.home.views.curator' %}' + '?album={{ album.id }}&albumChoiceOpen=1');
            }).on('hidden.bs.modal', function () {
                window.History.replaceState(null, '{{ title }}', '{% url 'project.home.views.curator' %}' + '?album={{ album.id }}');
            });
        });
        $(document).on('click', '#ajapaik-curator-open-area-modal', function () {
            $('#ajapaik-choose-area-modal').modal().on('shown.bs.modal', function () {
                $(window).resize(window.adjustModalMaxHeightAndPosition).trigger('resize');
                window.History.replaceState(null, '{{ title }}', '{% url 'project.home.views.curator' %}' + '?area={{ album.id }}&areaChoiceOpen=1');
            }).on('hidden.bs.modal', function () {
                window.History.replaceState(null, '{{ title }}', '{% url 'project.home.views.curator' %}' + '?area={{ album.id }}');
            });
        });
        $(document).on('click', '#ajapaik-curator-add-album-button', function () {
            $('#ajapaik-create-album-modal').modal().on('shown.bs.modal', function () {
                $(window).resize(window.adjustModalMaxHeightAndPosition).trigger('resize');
            });
        });
        $(document).on('click', '#ajapaik-curator-add-area-button', function () {
            $('#ajapaik-create-area-modal').modal().on('shown.bs.modal', function () {
                $(window).resize(window.adjustModalMaxHeightAndPosition).trigger('resize');
            });
        });
        $(document).on('click', '#ajapaik-curator-confirm-album-selection-button', function () {
            var checked = $('input[name="album_list[]"]:checked');
            selectedAlbums = [];
            var selectedNames = [];
            for (var i = 0; i < checked.length; i += 1) {
                selectedAlbums.push(parseInt(checked[i].value, 10));
                selectedNames.push(checked[i].dataset.albumName);
            }
            $('#ajapaik-curator-destination-album').find('span').html(selectedNames.join(', '));
            $('#ajapaik-choose-albums-modal').modal('toggle');
        });
        $(document).on('click', '#ajapaik-curator-confirm-area-selection-button', function () {
            var checked = $('input[name="area"]:checked');
            selectedArea = parseInt(checked[0].value, 10);
            selectedAreaName = checked[0].dataset.areaName;
            $('#ajapaik-curator-destination-area').find('span').html(selectedAreaName);
            $('#ajapaik-choose-area-modal').modal('toggle');
        });
        $(document).on('click', '#ajapaik-curator-save-new-album-button', function () {
            $.ajax({
                url: {% url 'project.home.views.public_add_album' %},
                type: 'POST',
                data: {
                    name: $('#ajapaik-curator-add-album-name').val(),
                    description: $('#ajapaik-curator-add-album-description').val(),
                    csrfmiddlewaretoken: window.docCookies.getItem('csrftoken')
                }
            }).success(function () {
                $('#ajapaik-curator-add-album-error').hide();
                window.location.reload();
            }).error(function () {
                $('#ajapaik-curator-add-album-error').show();
            });
        });
        var createResultElement = function (item) {
            fullResultSet[item.id] = item;
            var newResultItem = document.createElement('div'),
                newResultA = document.createElement('a'),
                newResultImage = document.createElement('img');
            $(newResultImage)
                    .addClass('img-responsive')
                    .addClass('ajapaik-result-item')
                    .attr('data-id', item.id)
                    .prop('src', 'http://ajapaik.ee:8080/ajapaik-service/images/' + item.cachedThumbnailUrl);
            $(newResultA)
                    .append(newResultImage)
                    .addClass('thumbnail');
            $(newResultItem)
                    .append(newResultA)
                    .addClass('col-xs-2');
            resultDiv.append(newResultItem);
        };
        var buildSelectionDiv = function () {
            selectionDiv.empty();
            for (var key in selectedResults) {
                if (selectedResults.hasOwnProperty(key)) {
                    var currentItem = selectedResults[key];
                    selectionDiv.append(tmpl('ajapaik-curator-selection-template', currentItem));
                }
            }
        };
        $(document).on('click', '.ajapaik-curator-load-more', function () {
            var slice = resultIds.slice(start, start + 200);
            start += 200;
            $.ajax({
                type : 'POST',
                url : url,
                data: {
                    ids: slice,
                    csrfmiddlewaretoken: window.docCookies.getItem('csrftoken')
                },
                success : function(msg) {
                    if (resultCount > start) {
                        $('.ajapaik-curator-load-more').show();
                    } else {
                        $('.ajapaik-curator-load-more').hide();
                    }
                    for (var i = 0, l = msg.result.length; i < l; i += 1) {
                        var item = msg.result[i];
                        createResultElement(item);
                    }
                }
            });
        });
        $(document).on('click', '#ajapaik-curator-search-button', function () {
            $.ajax({
                type : 'POST',
                url : url,
                data: {
                    fullSearch: $('#ajapaik-curator-full-search').val(),
                    csrfmiddlewaretoken: window.docCookies.getItem('csrftoken')
                },
                success : function(msg) {
                    resultIds = msg.result.ids;
                    resultCount = resultIds.length;
                    $('#ajapaik-curator-result-count').find('span').html(resultCount);
                    if (resultCount > 200) {
                        $('.ajapaik-curator-load-more').show();
                    } else {
                        $('.ajapaik-curator-load-more').hide();
                    }
                    for (var i = 0, l = msg.result.firstRecordViews.length; i < l; i += 1) {
                        var item = msg.result.firstRecordViews[i];
                        createResultElement(item);
                    }
                }
            });
        });
        $(document).on('click', '.ajapaik-result-item', function (e) {
            var target = fullResultSet[e.target.dataset.id];
            if (selectedResults[e.target.dataset.id]) {
                delete selectedResults[e.target.dataset.id];
                $(e.target).removeClass('ajapaik-curator-selected-image');
            } else {
                selectedResults[e.target.dataset.id] = target;
                $(e.target).addClass('ajapaik-curator-selected-image');
            }
        });
        $(document).on('click', '#ajapaik-curator-clear-selection', function () {
            selectedResults = {};
            buildSelectionDiv();
            $('.ajapaik-result-item').removeClass('ajapaik-curator-selected-image');
        });
        $(document).on('click', '#ajapaik-curator-save-new-area-button', function () {
            $.ajax({
                url: {% url 'project.home.views.public_add_area' %},
                type: 'POST',
                data: {
                    name: $('#ajapaik-curator-add-area-name').val(),
                    lat: $('#ajapaik-curator-add-area-lat').val(),
                    lon: $('#ajapaik-curator-add-area-lon').val(),
                    csrfmiddlewaretoken: window.docCookies.getItem('csrftoken')
                }
            }).success(function () {
                $('#ajapaik-curator-add-area-error').hide();
                window.location.reload();
            }).error(function () {
                $('#ajapaik-curator-add-area-error').show();
            });
        });
    });
</script>
{% verbatim %}
    <script id="ajapaik-curator-selection-template" type="text/x-tmpl">
        <div class="row ajapaik-curator-selection-item">
            <img class="col-xs-6 img-responsive" src="{%=o.imageUrl%}">
            <div class="col-xs-6">
                <div class="panel panel-primary">
                    <div class="panel-heading">
                        <h3 class="panel-title">{%=o.title%}</h3>
                    </div>
                    <ul class="list-group">
                        <li class="list-group-item">{%=gettext('Description')%} {%=o.description%}</li>
                        <li class="list-group-item">{%=gettext('Author')%} {%=o.creators%}</li>
                        <li class="list-group-item">{%=gettext('Width')%} {%=o.creators%}</li>
                        <li class="list-group-item">{%=gettext('Height')%} {%=o.creators%}</li>
                    </ul>
                </div>
            </div>
        </div>
    </script>
{% endverbatim %}
{% endblock %}