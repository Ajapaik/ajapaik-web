{% extends "base_bootstrap.html" %}
{% load thumbnail i18n compress %}

{% block header %}
    {% include "_header.html" %}
{% endblock %}

{% block layout %}
    {% include "_rephoto_upload_modal.html" %}
    <div class="full-box original-full-box">
        <div class="full-pic" id="ajapaik-fullscreen-image-container">
            <img id="ajapaik-full-screen-image" src="{{ fullscreen.url }}" alt="{% trans "Original photo on full screen" %}"/>
        </div>
    </div>
    {% if rephoto %}
        <div class="full-box rephoto-full-box">
            <div class="full-pic" id="ajapaik-rephoto-fullscreen-image-container">
                <img id="ajapaik-rephoto-full-screen-image" src="{% url 'project.home.views.photo_large' rephoto.id %}" alt="{% trans "Rephoto on full screen" %}"/>
            </div>
        </div>
    {% endif %}
    <div class="container-fluid" id="ajapaik-photoview-container">
        <div class="col-xs-10">
            <div class="row-fluid">
                <div class="{% if rephoto %}col-xs-6{% else %}col-xs-12{% endif %}">
                    <div id="ajapaik-photoview-main-photo-container">
                        <a class="fullscreen" id="ajapaik-full-screen-link">
                            <img id="ajapaik-photoview-main-photo" class="img-responsive col-xs-12
                            {% if photo.flip %}ajapaik-photo-flipped{% endif %}" alt="{% trans "Original photo" %}"
                             src="{% url 'project.home.views.photo_url' photo.id %}"/>
                        </a>
                        <button class="btn btn-default ajapaik-overlay-button ajapaik-flip-photo-overlay-button" style="display: none;"></button>
                    </div>
                    {% if photo.author %}
                        <div class="row-fluid">
                            <b>{{ photo.author }}</b>
                        </div>
                    {% endif %}
                    {% if photo.description %}
                        <div class="row-fluid">
                            {{ photo.description }}
                        </div>
                    {% endif %}
                    {% if photo.source_url %}
                        <div class="row-fluid">
                            <a onclick="window._gaq.push(['_trackEvent', 'Photoview', 'Source link click']);" href='{{ photo.source_url }}' target="_blank">
                                {{ photo.source.description }} {% if photo.source_key %}{{ photo.source_key }}{% endif %}
                            </a>{% if photo.licence %}{% include "_licence.html" with licence=photo.licence %}{% endif %}
                        </div>
                    {% elif photo.source.description %}
                        <div class="row-fluid">
                            {{ photo.source.description }}{% if photo.source_key %}{{ photo.source_key }}{% endif %}{% if photo.licence %}&nbsp;{% include "_licence.html" with licence=photo.licence %}{% endif %}
                        </div>
                    {% endif %}
                    <div class="row" style="margin-top: 10px;">
                        <div class="btn-group" role="group" aria-label="...">
                            <button id="ajapaik-sharing-dropdown-button" class="btn btn-primary"
                                    type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                {% trans "Share" %}
                            </button>
                            <ul class="dropdown-menu" role="menu" aria-labelledby="ajapaik-sharing-dropdown-button">
                                <li role="presentation" class="disabled-link">
                                    <div role="menuitem" tabindex="-1" id="ajapaik-grab-link">
                                        <input type="text" class="form-control"
                                               value="{{ hostname }}{{ photo.get_absolute_url }}">
                                    </div>
                                </li>
                                <li role="presentation">
                                    <div role="menuitem" tabindex="-1">
                                        <div class="fb-like" data-href="
                                                {{ hostname }}{% if rephoto %}{{ rephoto.get_absolute_url }}{% else %}{{ photo.get_absolute_url }}{% endif %}"
                                             data-layout="standard" data-action="like" data-show-faces="true"
                                             data-share="true"></div>
                                    </div>
                                </li>
                            </ul>
                            <span class="btn btn-success" id="ajapaik-photoview-add-rephoto-button">
                                <i class="glyphicon glyphicon-plus"></i>
                                <span>{% trans "Add rephoto" %}</span>
                            </span>
                            {% if photo.lat and photo.lon %}
                                <button class="btn btn-primary" id="ajapaik-photoview-map-button">
                                    {% trans "Location on the map" %}
                                </button>
                            {% endif %}
                        </div>
                    </div>
                    {% if albums %}
                        <div class="row" style="margin-top: 10px;">
                            <p class="text-left">
                                {% blocktrans count counter=albums|length %}
                                    Picture belongs to album
                                {% plural %}
                                    Picture belongs to albums:
                                {% endblocktrans %}
                                {% for a in albums %}
                                    <a href="{% url 'project.home.views.mapview' %}?album={{ a.id }}">{{ a.name }}</a>{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            </p>
                        </div>
                    {% endif %}
                </div>
                {% if rephoto %}
                    <div class="col-xs-6">
                        <div id="ajapaik-photoview-rephoto-container">
                            <a class="fullscreen" id="ajapaik-rephoto-full-screen-link">
                                <img id="ajapaik-photoview-rephoto" class="img-responsive col-xs-12
                                {% if rephoto.flip %}ajapaik-photo-flipped{% endif %}" alt="{% trans "Rephoto" %}"
                                     src="{% url 'project.home.views.photo_url' rephoto.id %}"/>
                            </a>
                            <button class="btn btn-default ajapaik-overlay-button ajapaik-close-rephoto-overlay-button" id="ajapaik-close-rephoto-overlay-button" {% if not request.mobile %}style="display: none;"{% endif %}></button>
                            <button class="btn btn-default ajapaik-overlay-button ajapaik-invert-rephoto-overlay-button" id="ajapaik-invert-rephoto-overlay-button" {% if not request.mobile %}style="display: none;"{% endif %}></button>
                        </div>
                        {% if rephoto.source and rephoto.source_key and rephoto.source_url %}
                            {% if rephoto.author %}
                                <div class="row-fluid"><b>{{ rephoto.author }}</b>{% if rephoto.licence %} {% include "_licence.html" with licence=rephoto.licence %}{% endif %}</div>
                            {% endif %}
                            <div class="row-fluid">
                                <a onclick="window._gaq.push(['_trackEvent', 'Photoview', 'Source link click']);" href='{{ rephoto.source_url }}' target="_blank">
                                    {{ rephoto.source.description }} {{ rephoto.source_key }}
                                </a>
                            </div>
                        {% elif rephoto.author %}
                            <div class="row-fluid"><b>{{ rephoto.author }}</b>{% if rephoto.licence %} {% include "_licence.html" with licence=rephoto.licence %}{% endif %}</div>
                        {% elif rephoto.user.fb_name %}
                            <div class="row-fluid">
                                <a id="ajapaik-photo-modal-rephoto-user-link" target="_blank" href="{{ rephoto.user.fb_link }}">{{ rephoto.user.fb_name }}</a>&nbsp;{% include '_licence.html' %}
                            </div>
                        {% else %}
                            <div class="row-fluid">
                                <b>{% trans "Unknown author" %}</b>
                            </div>
                        {% endif %}
                        {% if rephoto.date %}
                            <div class="row-fluid">
                                {% trans "Date taken" %}&nbsp;<div id="ajapaik-photoview-date-taken">{{ rephoto.date|date:"d.m.Y" }}</div>
                            </div>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
        <div class="col-xs-2">
            <div id="ajapaik-photoview-rephoto-selection">
                {% for rephoto in photo.rephotos.all %}
                    <div class="row ajapaik-no-right-margin-row ajapaik-no-left-margin-row">
                        <a href="{% url 'project.home.views.photo' rephoto.id %}" class="col-xs-12">
                            <img src="{% url 'project.home.views.photo_thumb' rephoto.id 250 %}" class="img-responsive col-xs-12 ajapaik-photoview-rephoto-thumb" alt="{% trans "Rephoto thumbnail" %}" />
                        </a>
                    </div>
                {% endfor %}
            </div>
        </div>
        {% include "_comments.html" %}
    </div>
{% endblock %}

{% block specific_js %}
    <script>
        window.albumId = '{{ album.id }}';
        window.photoId = '{{ photo.id }}';
        window.isPhotoview = true;
        window.gameRedirectURI = '/game?area=' + '{{ area.id }}';
        $(document).ready(function () {
            var rephotoUploadModal = $('#ajapaik-rephoto-upload-modal'),
                mainPhoto = $('#ajapaik-photoview-main-photo'),
                originalFullscreen = $('#ajapaik-full-screen-image');
            $('.dropdown-toggle').dropdown();
            $('.disabled-link').click(function (event) {
                event.preventDefault();
                event.stopPropagation();
            });
            window.prepareFullscreen({{ fullscreen.size.0 }}, {{ fullscreen.size.1 }}, '#ajapaik-full-screen-image');
            {% if rephoto %}
                window.prepareFullscreen({{ rephoto_fullscreen.size.0 }}, {{ rephoto_fullscreen.size.1 }}, '#ajapaik-rephoto-full-screen-image');
            {% endif %}
            $(document).on('click', '.ajapaik-flip-photo-overlay-button', function () {
                var $this = $(this);
                if ($this.hasClass('active')) {
                    $this.removeClass('active');
                } else {
                    $this.addClass('active');
                }
                if (mainPhoto.hasClass('ajapaik-photo-flipped')) {
                    mainPhoto.removeClass('ajapaik-photo-flipped');
                } else {
                    mainPhoto.addClass('ajapaik-photo-flipped');
                }
                if (originalFullscreen.hasClass('ajapaik-photo-flipped')) {
                    originalFullscreen.removeClass('ajapaik-photo-flipped');
                } else {
                    originalFullscreen.addClass('ajapaik-photo-flipped');
                }
            });
{% comment %}            $('.full-box div').on('click', function (e) {
                if (BigScreen.enabled) {
                    e.preventDefault();
                    window.fullscreenEnabled = false;
                    BigScreen.exit();
                }
            });{% endcomment %}
            if (window.isMobile) {
                $('.ajapaik-flip-photo-overlay-button').show();
            }
            $(document).on('mouseover', '#ajapaik-photoview-main-photo-container', function () {
                if (!window.isMobile) {
                    $('.ajapaik-flip-photo-overlay-button').show();
                }
            });
            $(document).on('mouseout', '#ajapaik-photoview-main-photo-container', function () {
                if (!window.isMobile) {
                    $('.ajapaik-flip-photo-overlay-button').hide();
                }
            });
            $(document).on('mouseover', '#ajapaik-photoview-rephoto-container', function () {
                if (!window.isMobile) {
                    $('#ajapaik-close-rephoto-overlay-button').show();
                    $('#ajapaik-invert-rephoto-overlay-button').show();
                }
            });
            $(document).on('mouseout', '#ajapaik-photoview-rephoto-container', function () {
                if (!window.isMobile) {
                    $('#ajapaik-close-rephoto-overlay-button').hide();
                    $('#ajapaik-invert-rephoto-overlay-button').hide();
                }
            });
            $(document).on('click', '#ajapaik-photoview-add-rephoto-button', function () {
                $.ajax({
                    cache: false,
                    url: '/photo_upload_modal/' + {{ photo.id }} + '/',
                    success: function (result) {
                        rephotoUploadModal.data('bs.modal', null);
                        rephotoUploadModal.html(result).modal();
                    }
                });
            });
            $(document).on('click', '#ajapaik-photoview-map-button', function () {
                {% if album.id %}
                    window.location.href = '/map/photo/' + {{ photo.id }} + '?album=' + {{ album.id }};
                {% else %}
                    window.location.href = '/map/photo/' + {{ photo.id }} + '?area=' + {{ area.id }};
                {% endif %}
            });
            $(document).on('click', '#ajapaik-photoview-header-game-button', function () {
                var albumId = $('#id_album').val(),
                    gameURL = '{% url 'project.home.views.game' %}';
                window.location.href =  gameURL + '?album=' + albumId;
            });
            $(document).on('click', '#ajapaik-photoview-header-map-button', function () {
                var albumId = $('#id_album').val(),
                    mapURL = '{% url 'project.home.views.mapview' %}';
                window.location.href =  mapURL + '?album=' + albumId;
            });
            $(document).on('click', '#ajapaik-close-rephoto-overlay-button', function (e) {
                e.stopPropagation();
                window.location.href = '/foto/' + {{ photo.id }};
            });
            $(document).on('click', '#ajapaik-invert-rephoto-overlay-button', function (e) {
                e.stopPropagation();
                var targetDiv = $('#ajapaik-photoview-rephoto');
                if (targetDiv.hasClass('ajapaik-photo-bw')) {
                    targetDiv.removeClass('ajapaik-photo-bw');
                } else {
                    targetDiv.addClass('ajapaik-photo-bw');
                }
            });
            $('#ajapaik-comment-tabs a').click(function (e) {
                e.preventDefault();
                window.FB.XFBML.parse($('#ajapaik-rephoto-comments').get(0));
                window.FB.XFBML.parse($('#ajapaik-original-photo-comments').get(0));
                $(this).tab('show')
            });
            window.uploadCompleted = function (response) {
                $('#ajapaik-rephoto-upload-modal').modal('toggle');
                if (response && response.new_id) {
                    window.location.reload();
                }
            };
            window._gaq.push(['_trackPageview', '{{ photo.get_absolute_url }}']);
        });
    </script>
{% endblock %}