{% extends "base_bootstrap.html" %}
{% load thumbnail i18n %}

{% block header %}
    {% include "_header.html" %}
    <link rel="stylesheet" href="{{ STATIC_URL }}libs/jQuery-File-Upload-9.9.2/css/jquery.fileupload.css">
    <link rel="stylesheet" href="{{ STATIC_URL }}libs/bootstrap-datetimepicker-3.1.3/css/bootstrap-datetimepicker.min.css">
{% endblock %}

{% block layout %}
    <div class="modal fade" id="ajapaik-rephoto-upload-modal" tabindex="-1" role="dialog" aria-labelledby="ajapaik-rephoto-upload-modal-label" aria-hidden="true"></div>
    <div class="{% if rephoto %}container-fluid{% else %}container{% endif %}" id="ajapaik-photoview-container">
        <div class="row ajapaik-no-left-margin-row">
            <div class="col-xs-10">
                {% if rephoto %}
                    <div class="row">
                        <div class="col-xs-6">
                            <div id="ajapaik-photoview-main-photo-container">
                                <a class="fullscreen col-xs-12" rel="{{ photo.id }}" href="{{ photo.get_absolute_url }}" id="ajapaik-photoview-original-full-screen-link">
                                    <img id="ajapaik-photoview-main-photo" class="img-responsive col-xs-12 {% if photo.flip %}flip-photo{% endif %}" src="{% url 'project.home.views.photo_large' photo.id %}"/>
                                </a>
                                <button class="btn btn-default ajapaik-overlay-button ajapaik-flip-photo-overlay-button" style="display: none;"></button>
                            </div>
                            {% if photo.description %}
                                <div class="row ajapaik-no-left-margin-row">
                                    <p>{{ photo.description }}</p>
                                </div>
                            {% endif %}
                            <div class="row ajapaik-no-left-margin-row">
                                <div>
                                    {% if photo.source_url %}
                                        <div class="row col-xs-12">
                                            <a onclick="window._gaq.push(['_trackEvent', 'Photoview', 'Source link click']);"
                                               href='{{ photo.source_url }}' target="_blank">
                                                {{ photo.source.description }}{% if photo.source_key %}
                                                    {{ photo.source_key }}{% endif %}
                                            </a>
                                        </div>
                                    {% elif photo.source.description %}
                                        <div class="row">
                                            {{ photo.source.description }}{% if photo.source_key %}
                                                {{ photo.source_key }}{% endif %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-xs-6">
                            <div id="ajapaik-photoview-rephoto-container">
                                <a class="fullscreen col-xs-12" rel="{{ rephoto.id }}" id="ajapaik-photoview-rephoto-full-screen-link">
                                    <img id="ajapaik-photoview-rephoto" class="img-responsive col-xs-12 {% if rephoto.flip %}flip-photo{% endif %}" src="{% url 'project.home.views.photo_large' rephoto.id %}"/>
                                </a>
                                <button class="btn btn-default ajapaik-overlay-button ajapaik-close-rephoto-overlay-button" id="ajapaik-close-rephoto-overlay-button" {% if not request.mobile %}style="display: none;"{% endif %}></button>
                            </div>
                            <div class="row ajapaik-no-left-margin-row col-xs-12">
                                {% trans "Rephotograph by" %}&nbsp;<a id="ajapaik-photo-modal-rephoto-user-link" target="_blank" href="{{ rephoto.user.fb_link }}">{{ rephoto.user.fb_name }}</a>&nbsp;{% include '_creative_commons.html' %}
                            </div>
                            {% if rephoto.date %}
                                <div class="row ajapaik-no-left-margin-row col-xs-12">
                                    {% trans "Date taken" %}&nbsp;
                                    <div id="ajapaik-photoview-date-taken">{{ rephoto.date }}</div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <button class="btn btn-primary pull-right" id="ajapaik-photoview-map-button">{% trans "Map" %}</button>
                    <span class="btn btn-success pull-right" id="ajapaik-photoview-add-rephoto-button">
                        <i class="glyphicon glyphicon-plus"></i>
                        <span>{% trans "Add rephoto" %}</span>
                    </span>
                    <div class="col-xs-10 col-lg6">
                        {% include "_comments.html" %}
                    </div>
                {% else %}
                    <div class="row ajapaik-no-left-margin-row">
                        <div id="ajapaik-photoview-main-photo-container">
                            <a class="fullscreen" rel="{{ photo.id }}" href="{{ photo.get_absolute_url }}">
                                <img id="ajapaik-photoview-main-photo" class="img-responsive {% if photo.flip %}flip-photo{% endif %}" src="{% url 'project.home.views.photo_large' photo.id %}"/>
                            </a>
                            <button class="btn btn-default ajapaik-overlay-button ajapaik-flip-photo-overlay-button" style="display: none;"></button>
                        </div>
                    </div>
                    {% if photo.description %}
                        <div class="row ajapaik-no-left-margin-row">
                            <p>{{ photo.description }}</p>
                        </div>
                    {% endif %}
                    <div class="row ajapaik-no-left-margin-row">
                        <div class="col-xs-6">
                            {% if photo.source_url %}
                                <div class="row">
                                    <a onclick="window._gaq.push(['_trackEvent', 'Photoview', 'Source link click']);"
                                       href='{{ photo.source_url }}' target="_blank">
                                        {{ photo.source.description }}{% if photo.source_key %}
                                            {{ photo.source_key }}{% endif %}
                                    </a>
                                </div>
                            {% elif photo.source.description %}
                                <div class="row">
                                    {{ photo.source.description }}{% if photo.source_key %}
                                        {{ photo.source_key }}{% endif %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <button class="btn btn-primary pull-right" id="ajapaik-photoview-map-button">{% trans "Map" %}</button>
                    <span class="btn btn-success pull-right" id="ajapaik-photoview-add-rephoto-button">
                        <i class="glyphicon glyphicon-plus"></i>
                        <span>{% trans "Add rephoto" %}</span>
                    </span>
                    {% include "_comments.html" %}
                {% endif %}
            </div>
            <div class="col-xs-2">
                <div class="row col-xs-12" id="ajapaik-photoview-rephoto-selection">
                    {% for rephoto in photo.rephotos.all %}
                        <div class="row ajapaik-no-left-margin-row" style="display: inline-block;">
                            <a href="{% url 'project.home.views.photo' rephoto.id %}">
                                <img src="{% url 'project.home.views.photo_thumb' rephoto.id %}" class="img-responsive ajapaik-photoview-rephoto-thumb" />
                            </a>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment.min.js"></script>
    <script src="http://blueimp.github.io/JavaScript-Load-Image/js/load-image.all.min.js"></script>
    <script src="http://blueimp.github.io/JavaScript-Canvas-to-Blob/js/canvas-to-blob.min.js"></script>
    <script src="{{ STATIC_URL }}/libs/jQuery-File-Upload-9.9.2/js/jquery.iframe-transport.js"></script>
    <script src="{{ STATIC_URL }}/libs/jQuery-File-Upload-9.9.2/js/jquery.fileupload.js"></script>
    <script src="{{ STATIC_URL }}/libs/jQuery-File-Upload-9.9.2/js/jquery.fileupload-process.js"></script>
    <script src="{{ STATIC_URL }}/libs/jQuery-File-Upload-9.9.2/js/jquery.fileupload-image.js"></script>
    <script src="{{ STATIC_URL }}/libs/jQuery-File-Upload-9.9.2/js/jquery.fileupload-validate.js"></script>
    <script src="{{ STATIC_URL }}/libs/bootstrap-datetimepicker-3.1.3/js/bootstrap-datetimepicker.min.js"></script>
    <script src="{{ STATIC_URL }}/js/ajapaik-common.js"></script>
    <script>
    $(document).ready(function () {
        var rephotoUploadModal = $('#ajapaik-rephoto-upload-modal');
        var mainPhoto = $('#ajapaik-photoview-main-photo');
        $(document).on('click', '.ajapaik-flip-photo-overlay-button', function () {
            var $this = $(this);
            if ($this.hasClass('active')) {
                $this.removeClass('active');
            } else {
                $this.addClass('active');
            }
            if (mainPhoto.hasClass('ajapaik-photo-flipped')) {
                mainPhoto.removeClass('ajapaik-photo-flipped');
            } else {
                mainPhoto.addClass('ajapaik-photo-flipped');
            }
        });
        if (window.isMobile) {
            $('.ajapaik-flip-photo-overlay-button').show();
        }
        $(document).on('mouseover', '#ajapaik-photoview-main-photo-container', function () {
            if (!window.isMobile) {
                $('.ajapaik-flip-photo-overlay-button').show();
            }
        });
        $(document).on('mouseout', '#ajapaik-photoview-main-photo-container', function () {
            if (!window.isMobile) {
                $('.ajapaik-flip-photo-overlay-button').hide();
            }
        });
        $(document).on('mouseover', '#ajapaik-photoview-rephoto-container', function () {
            if (!window.isMobile) {
                $('#ajapaik-close-rephoto-overlay-button').show();
            }
        });
        $(document).on('mouseout', '#ajapaik-photoview-rephoto-container', function () {
            if (!window.isMobile) {
                $('#ajapaik-close-rephoto-overlay-button').hide();
            }
        });
        $(document).on('click', '#ajapaik-photoview-add-rephoto-button', function () {
            $.ajax({
                cache: false,
                url: '/photo_upload_modal/' + {{ photo.id }} + '/',
                success: function (result) {
                    rephotoUploadModal.data('bs.modal', null);
                    rephotoUploadModal.html(result).modal().on('shown.bs.modal', function () {
                        $(window).resize(window.adjustModalMaxHeightAndPosition).trigger('resize');
                    });
                }
            });
        });
        $(document).on('click', '#ajapaik-photoview-map-button', function () {
             window.location.href = '/map/photo/' + {{ photo.id }};
        });
        $(document).on('click', '#ajapaik-close-rephoto-overlay-button', function () {
            window.location.href = '/foto/' + {{ photo.id }};
        });
        $('#ajapaik-comment-tabs a').click(function (e) {
            e.preventDefault();
            $(this).tab('show')
        });
        window.uploadCompleted = function (response) {
            $('#ajapaik-rephoto-upload-modal').modal('toggle');
            if (response && response.new_id) {
                window.location.reload();
            }
        };
    });
</script>
{% endblock %}