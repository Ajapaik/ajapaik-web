{% load thumbnail i18n %}

<div class="modal-dialog modal-lg" id="mapview-photo-modal-dialog">
    <div class="modal-content">
        <div class="modal-header ajapaik-no-bottom-border-modal-header" id="ajapaik-photo-modal-header">
            <button id="ajapaik-photo-modal-close-button" type="button" class="close" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="modal-body" id="ajapaik-modal-body">
            <div class="row">
                {% if photo.rephotos.all|length == 0 %}
                    <div class="col-xs-12" id="ajapaik-photo-modal-original-photo-column">
                {% elif photo.rephotos.all|length > 1 %}
                    <div class="col-xs-5" id="ajapaik-photo-modal-original-photo-column">
                {% else %}
                    <div class="col-xs-6" id="ajapaik-photo-modal-original-photo-column">
                {% endif %}
                    <div id="ajapaik-modal-photo-container">
                        <a class="fullscreen col-xs-12" id="ajapaik-full-screen-link" rel="" href="">
                            <img src="{% url 'project.home.views.photo_url' photo.id %}"
                                 class="img-responsive col-xs-12 {% if photo.flip %}ajapaik-photo-flipped{% endif %}"
                                 id="ajapaik-modal-photo"/>
                        </a>
                        <button class="btn btn-default ajapaik-flip-photo-overlay-button {% if photo.flip %}active{% endif %}" {% if not request.mobile %}style="display: none;"{% endif %}></button>
                        {% if photo.rephotos.all.0 %}
                            <button class="btn btn-default ajapaik-overlay-button ajapaik-show-rephoto-selection-overlay-button {% if photo.rephotos.all|length < 10 %}ajapaik-show-rephoto-selection-overlay-button-{{ photo.rephotos.all | length }}{% else %}ajapaik-show-rephoto-selection-overlay-button-9-plus{% endif %}" id="ajapaik-show-rephoto-selection-overlay-button" {% if not request.mobile %}style="display: none;"{% endif %}></button>
                        {% endif %}
                    </div>
                </div>
                {% if photo.rephotos.all.0 %}
                    {% if photo.rephotos.all|length > 1 %}
                        <div class="col-xs-5" id="ajapaik-photo-modal-rephoto-column">
                    {% else %}
                        <div class="col-xs-6" id="ajapaik-photo-modal-rephoto-column">
                    {% endif %}
                    <div id="ajapaik-modal-rephoto-container">
                        <img src="{% url 'project.home.views.photo_url' photo.rephotos.all.0.id %}" class="img-responsive col-xs-12" id="ajapaik-modal-rephoto"/>
                        <button class="btn btn-default ajapaik-overlay-button ajapaik-close-rephoto-overlay-button" id="ajapaik-close-rephoto-overlay-button" {% if not request.mobile %}style="display: none;"{% endif %}></button>
                        <button class="btn btn-default ajapaik-overlay-button ajapaik-invert-rephoto-overlay-button" id="ajapaik-invert-rephoto-overlay-button" {% if not request.mobile %}style="display: none;"{% endif %}></button>
                    </div>
                    </div>
                    {% if photo.rephotos.all|length > 1 %}
                        <div class="col-xs-2" id="ajapaik-rephoto-selection">
                            {% for rephoto in photo.rephotos.all %}
                                <div class="row ajapaik-photo-modal-rephoto-thumb" id="ajapaik-rephoto-thumb-{{ rephoto.id }}">
                                    <img class="img-responsive"
                                         src="{% url 'project.home.views.photo_thumb' rephoto.id 100 %}"
                                         data-id="{{ rephoto.id }}" />
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endif %}
            </div>
        </div>
        <div class="modal-footer">
            <div class="row">
                {% if photo.rephotos.all|length > 1 %}
                    <div id="ajapaik-photo-modal-original-photo-info-column">
                {% elif photo.rephotos.all|length == 0 %}
                    <div id="ajapaik-photo-modal-original-photo-info-column">
                {% else %}
                    <div id="ajapaik-photo-modal-original-photo-info-column">
                {% endif %}
                {% if photo.author %}
                    <div class="row ajapaik-photo-modal-row" id="ajapaik-photo-modal-author"><b>{{ photo.author }}</b></div>
                {% endif %}
                {% if photo.description %}
                    <div class="row ajapaik-photo-modal-row" id="ajapaik-photo-modal-description">{{ photo.description }}</div>
                {% endif %}
                {% if photo.source_url %}
                    <div class="row ajapaik-photo-modal-row" id="ajapaik-photo-modal-source">
                        <a onclick="window._gaq.push(['_trackEvent', 'Map', 'Source link click']);" href='{{ photo.source_url }}'
                           target="_blank">
                            {{ photo.source.description }}{% if photo.source_key %} {{ photo.source_key }}{% endif %}{% if photo.licence %}{% include "_licence.html" with licence=photo.licence %}{% endif %}
                        </a>
                    </div>
                {% elif photo.source.description %}
                    <div class="row ajapaik-photo-modal-row" id="ajapaik-photo-modal-source">
                        {{ photo.source.description }}{% if photo.source_key %} {{ photo.source_key }}{% endif %}{% if photo.licence %}{% include "_licence.html" with licence=photo.licence %}{% endif %}
                    </div>
                {% endif %}
                </div>
                {% if photo.rephotos.all|length > 0 %}
                    {% if photo.rephotos.all|length > 1 %}
                        <div class="col-xs-5" id="ajapaik-photo-modal-rephoto-info-column">
                    {% else %}
                        <div class="col-xs-6" id="ajapaik-photo-modal-rephoto-info-column">
                    {% endif %}
                    {% if photo.rephotos.all.0.source and photo.rephotos.all.0.source_key and photo.rephotos.all.0.source_url %}
                        {% if photo.rephotos.all.0.author %}
                            <div class="row ajapaik-photo-modal-row"><b>{{ photo.rephotos.all.0.author }}</b>{% if photo.rephotos.all.0.licence %} {% include "_licence.html" with licence=photo.rephotos.all.0.licence %}{% endif %}</div>
                        {% endif %}
                        <div class="row ajapaik-photo-modal-row">
                            <a onclick="window._gaq.push(['_trackEvent', 'Map', 'Source link click']);" href='{{ photo.rephotos.all.0.source_url }}'
                               target="_blank">
                                {{ photo.rephotos.all.0.source.desription }} {{ photo.rephotos.all.0.source_key }}
                            </a>
                        </div>
                    {% else %}
                        {% if photo.rephotos.all.0.author %}
                            <div class="row ajapaik-photo-modal-row"><b>{{ photo.rephotos.all.0.author }}</b>{% if photo.rephotos.all.0.licence %} {% include "_licence.html" with licence=photo.rephotos.all.0.licence %}{% endif %}</div>
                        {% else %}
                            {% if photo.rephotos.all.0.user %}
                                <div class="row ajapaik-photo-modal-row">
                                    <a target="_blank" href="{{ photo.rephotos.all.0.user.fb_link }}">
                                        {{ photo.rephotos.all.0.user.fb_name }}
                                    </a>
                                    {% if photo.rephotos.all.0.licence %} {% include "_licence.html" with licence=photo.rephotos.all.0.licence %}{% endif %}
                                </div>
                            {% else %}
                                <div class="row ajapaik-photo-modal-row"><b>{% trans "Unknown author" %}</b></div>
                            {% endif %}
                        {% endif %}
                    {% endif %}
                    {% if photo.rephotos.all.0.date %}
                        <div class="row ajapaik-photo-modal-row">
                            {{ photo.rephotos.all.0.date|date:"d.m.Y" }}
                        </div>
                    {% endif %}
                    </div>
                {% endif %}
            </div>
            <div class="row-fluid" style="margin-top: 10px;">
                <div class="btn-group btn-group-justified" role="group" aria-label="...">
                    <div class="btn-group" role="group">
                        <div class="dropdown">
                            <button id="ajapaik-sharing-dropdown-button"
                                    class="btn btn-sm btn-block btn-primary ajapaik-photo-modal-share-button ajapaik-btn-white-space-nowrap"
                                    type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                {% trans "Share" %}
                            </button>
                            <ul class="dropdown-menu" role="menu" aria-labelledby="ajapaik-sharing-dropdown-button">
                                <li role="presentation" class="disabled-link">
                                    <a role="menuitem" tabindex="-1" id="ajapaik-grab-link">
                                        <input type="text" class="form-control"
                                               value="{{ hostname }}{{ photo.get_absolute_url }}">
                                    </a>
                                </li>
                                <li role="presentation">
                                    <a role="menuitem" tabindex="-1">
                                        <div class="fb-like" data-href="{{ hostname }}{{ photo.get_absolute_url }}"
                                             data-layout="standard" data-action="like" data-show-faces="true"
                                             data-share="true"></div>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-block btn-primary ajapaik-photo-modal-comment-button ajapaik-btn-white-space-nowrap">
                            {% trans "Discuss" %} <span data-href="{{ fb_url }}" class="badge fb-comments-count"></span>
                        </button>
                    </div>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-block btn-success ajapaik-photo-modal-add-rephoto-button ajapaik-btn-white-space-nowrap">
                            {% trans "Add rephoto" %}
                        </button>
                    </div>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-block btn-success ajapaik-photo-modal-specify-location-button ajapaik-btn-white-space-nowrap">
                            {% trans "Specify location" %}
                        </button>
                    </div>
                </div>
                <div class="ajapaik-margin-top-5">
                    {% if geotag_count > 0 %}
                        {% if geotag_count == 1 %}
                            <p class="text-left">{{ geotag_count }} {% trans "user has submitted a location for this picture" %}
                        {% else %}
                            <p class="text-left">{{ geotag_count }} {% trans "users have submitted a location for this picture" %}
                        {% endif %}
                        </p>
                    {% endif %}
                    {% if albums|length > 0 %}
                        <p class="text-left">
                            {% blocktrans count counter=albums|length %}
                                Picture belongs to album
                            {% plural %}
                                Picture belongs to albums:
                            {% endblocktrans %}
                            {% for a in albums %}
                                <a href="{% url 'project.home.views.mapview' %}?album={{ a.id }}">{{ a.name }}</a>{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
<div class="full-box">
    <div class="full-pic" id="ajapaik-fullscreen-image-container">
        <img id="ajapaik-full-screen-image" src="{{ fullscreen.url }}"/>
    </div>
</div>
{% comment %}<div class="full-box">
    <div class="full-pic" id="ajapaik-rephoto-fullscreen-image-container">
        <img id="ajapaik-rephoto-full-screen-image" src="{% url 'project.home.views.photo_large' rephoto.id %}"/>
    </div>
</div>{% endcomment %}
<script>
    var rephotoUploadModal = $('#ajapaik-rephoto-upload-modal'),
        hostname = '{{ hostname }}',
        originalPhotoAbsoluteURL = '{{ photo.get_absolute_url }}';
    window.photoModalCurrentImageUrl = '{% url 'project.home.views.photo_url' photo.id %}';
    {% if photo.flip %}
        window.photoModalCurrentPhotoFlipStatus = true;
    {% else %}
        window.photoModalCurrentPhotoFlipStatus = false;
    {% endif %}
    window.photoModalRephotoArray = [];
    window.photoModalCurrentlyOpenPhotoId = {{ photo.id }};
    {% for rephoto in photo.rephotos.all %}
        window.photoModalRephotoArray.push({
            id: {{ rephoto.id }},
            url: '{% url 'project.home.views.photo_url' rephoto.id %}',
            {% if rephoto.date %}
                date: '{{ rephoto.date|date:"d.m.Y" }}',
            {% endif %}
            {% if rephoto.user %}
                FBUserName: '{{ rephoto.user.fb_name }}',
                FBUserLink: '{{ rephoto.user.fb_link }}',
            {% endif %}
            {% if rephoto.author %}
                author: '{{ rephoto.author }}',
            {% endif %}
            {% if rephoto.licence %}
                licence: true,
            {% endif %}
            {% if rephoto.source %}
                source: '{{ rephoto.source.description }}',
                sourceKey: '{{ rephoto.source_key }}',
                sourceURL: '{{ rephoto.source_url }}'
            {% endif %}
        });
    {% endfor %}
    $(document).ready(function () {
        $('.dropdown-toggle').dropdown();
        $('.disabled-link').click(function (event) {
            event.preventDefault();
            event.stopPropagation();
        });
        if (window.userClosedRephotoTools) {
            $('#ajapaik-rephoto-selection').hide();
            $('#ajapaik-photo-modal-rephoto-column').hide();
            $('#ajapaik-photo-modal-original-photo-info-column').removeClass('col-xs-5').removeClass('col-xs-6').addClass('col-xs-12');
            $('#ajapaik-photo-modal-rephoto-info-column').hide();
            $('#ajapaik-photo-modal-original-photo-column').removeClass('col-xs-5').removeClass('col-xs-6').addClass('col-xs-12');
        }
        {% comment %}if (window.photoModalRephotoArray && window.photoModalRephotoArray[0] && window.photoModalRephotoArray[0][2] !== 'None' && window.photoModalRephotoArray[0][2] !== '') {
            $('#ajapaik-photo-modal-date-row').show();
        }{% endcomment %}
        var openPhotoUploadModal = function () {
            $.ajax({
                cache: false,
                url: '/photo_upload_modal/' + window.photoModalCurrentlyOpenPhotoId + '/',
                success: function (result) {
                    rephotoUploadModal.data('bs.modal', null);
                    rephotoUploadModal.html(result).modal().on('shown.bs.modal', function () {
                        $(window).resize(window.adjustModalMaxHeightAndPosition).trigger('resize');
                    });
                }
            });
        };
        //TODO: Restore?
        {#History.replaceState(null, '{{ title }} - {% trans "Timepatch (Ajapaik)" %}', '{% if photo.rephotos.all.0 %}{{ photo.rephotos.all.0.get_absolute_url }}{% else %}{{ photo.get_absolute_url }}{% endif %}');#}
        //$('.filter-box').hide();
        window.currentPhotoURL = '{% url 'project.home.views.photo_url' photo.id %}';
        {% if description %}
            window.currentPhotoDescription = '{{ description }}';
        {% else %}
            window.currentPhotoDescription = false;
        {% endif %}
        window.photoModalFullscreenImageUrl = '{{ fullscreen.url }}';
        window.photoModalFullscreenImageSize = {{ fullscreen.size }};
        //window.photoModalRephotoFullscreenImageUrl = '{{ rephoto_fullscreen.url }}';
        //window.photoModalRephotoFullscreenImageSize = {{ rephoto_fullscreen.size }};
        window._gaq.push(['_trackPageview', '{{ photo.get_absolute_url }}']);
        $(".ajapaik-flip-photo-overlay-button").click(function () {
            var target = $("#ajapaik-modal-photo"),
                fullScreenImage = $('#ajapaik-full-screen-image');
            if ($(this).hasClass('active')) {
                $(this).removeClass('active');
            } else {
                $(this).addClass('active');
            }
            if (target.hasClass("ajapaik-photo-flipped")) {
                target.removeClass("ajapaik-photo-flipped");
            } else {
                target.addClass("ajapaik-photo-flipped");
            }
            if (fullScreenImage.hasClass("ajapaik-photo-flipped")) {
                fullScreenImage.removeClass("ajapaik-photo-flipped");
            } else {
                fullScreenImage.addClass("ajapaik-photo-flipped");
            }
            window.flipPhoto();
        });
        $(".ajapaik-photo-modal-specify-location-button").click(function () {
            window.startGuessLocation();
        });
        $('#ajapaik-photo-modal-close-button').click(function (e) {
            e.preventDefault();
            window.closePhotoDrawer();
        });
        $('.full-box div').on('click', function (e) {
            if (BigScreen.enabled) {
                e.preventDefault();
                window.fullscreenEnabled = false;
                BigScreen.exit();
            }
        });
        $(document).on('click', '#ajapaik-full-screen-link', function (e) {
            e.preventDefault();
            if (BigScreen.enabled) {
                BigScreen.request($('#ajapaik-fullscreen-image-container')[0]);
                window.fullscreenEnabled = true;
                window._gaq.push(['_trackEvent', 'Map', 'Full-screen']);
            }
        });
        {% comment %}$(document).on('click', '#ajapaik-rephoto-full-screen-link', function (e) {
            e.preventDefault();
            if (BigScreen.enabled) {
                BigScreen.request($('#ajapaik-rephoto-fullscreen-image-container')[0]);
                window.fullscreenEnabled = true;
                window._gaq.push(['_trackEvent', 'Map', 'Full-screen']);
            }
        });{% endcomment %}
        $(document).on('click', '#ajapaik-show-rephoto-selection-overlay-button', function () {
            $(this).hide();
            window.userClosedRephotoTools = false;
            var rephotoColumn = $('#ajapaik-photo-modal-rephoto-column'),
                rephotoInfoColumn = $('#ajapaik-photo-modal-rephoto-info-column'),
                originalPhotoInfoColumn = $('#ajapaik-photo-modal-original-photo-info-column'),
                rephotoDiv = $('#ajapaik-modal-rephoto-container');
            if (window.photoModalRephotoArray.length > 1) {
                $('#ajapaik-rephoto-selection').show();
                $('#ajapaik-photo-modal-original-photo-column').removeClass('col-xs-12').addClass('col-xs-5');
                rephotoInfoColumn.removeClass('col-xs-12').removeClass('col-xs-6').addClass('col-xs-5');
                originalPhotoInfoColumn.removeClass('col-xs-12').removeClass('col-xs-6').addClass('col-xs-5');
            } else {
                $('#ajapaik-photo-modal-original-photo-column').removeClass('col-xs-12').addClass('col-xs-6');
                rephotoColumn.removeClass('col-xs-5').addClass('col-xs-6');
                rephotoInfoColumn.removeClass('col-xs-12').removeClass('col-xs-5').addClass('col-xs-6');
                originalPhotoInfoColumn.removeClass('col-xs-12').removeClass('col-xs-5').addClass('col-xs-6');
            }
            rephotoInfoColumn.show();
            rephotoColumn.show();
            window.currentlySelectedRephotoId = window.photoModalRephotoArray[0]['id'];
            rephotoDiv.html(tmpl('ajapaik-photo-modal-rephoto-template', window.photoModalRephotoArray[0]));
            rephotoInfoColumn.html(tmpl('ajapaik-photo-modal-rephoto-info-template', window.photoModalRephotoArray[0]));
            window.syncMapStateToURL();
        });
        $(document).on('click', '.ajapaik-photo-modal-rephoto-thumb', function (e) {
            var targetId = e.target.dataset.id,
                infoDiv = $('#ajapaik-photo-modal-rephoto-info-column'),
                photoDiv = $('#ajapaik-modal-rephoto-container');
            if (!targetId) {
                targetId = window.currentlySelectedRephotoId;
            }
            infoDiv.show();
            for (var i = 0; i < window.photoModalRephotoArray.length; i += 1) {
                if (window.photoModalRephotoArray[i]['id'] == targetId) {
                    photoDiv.html(tmpl('ajapaik-photo-modal-rephoto-template', window.photoModalRephotoArray[i]));
                    infoDiv.html(tmpl('ajapaik-photo-modal-rephoto-info-template', window.photoModalRephotoArray[i]));
                    window.currentlySelectedRephotoId = targetId;
                    window.syncMapStateToURL();
                    break;
                }
            }
        });
        $(document).on('click', '#ajapaik-close-rephoto-overlay-button', function (e) {
            e.preventDefault();
            $('#ajapaik-photo-modal-rephoto-column').hide();
            $('#ajapaik-rephoto-selection').hide();
            $('#ajapaik-show-rephoto-selection-overlay-button').show();
            $('#ajapaik-grab-link').find('input').prop('value', hostname + originalPhotoAbsoluteURL);
            $('#ajapaik-photo-modal-original-photo-column').removeClass('col-xs-5').removeClass('col-xs-6').addClass('col-xs-12');
            $('#ajapaik-photo-modal-rephoto-info-column').hide();
            $('#ajapaik-photo-modal-original-photo-info-column').removeClass('col-xs-5').removeClass('col-xs-6').addClass('col-xs-12');
            window.currentlySelectedRephotoId = false;
            window.syncMapStateToURL();
            window.userClosedRephotoTools = true;
        });
        $(document).on('click', '.ajapaik-photo-modal-comment-button', function () {
            window.location.href = '{% url 'project.home.views.photo' photo.id %}';
        });
        $('#ajapaik-photo-modal-original-photo-column').hoverIntent(function () {
            if (!isMobile) {
                $('.ajapaik-flip-photo-overlay-button').show();
                if (window.userClosedRephotoTools) {
                    $('#ajapaik-show-rephoto-selection-overlay-button').show();
                }
            }
        }, function () {
            if (!isMobile) {
                $('.ajapaik-flip-photo-overlay-button').hide();
                $('#ajapaik-show-rephoto-selection-overlay-button').hide();
            }
        });
        $(document).on('click', '.ajapaik-photo-modal-add-rephoto-button', function () {
            openPhotoUploadModal();
        });
        $('#ajapaik-photo-modal-rephoto-column').hoverIntent(function () {
            if (!isMobile) {
                if (!window.userClosedRephotoTools) {
                    $('#ajapaik-close-rephoto-overlay-button').show();
                    $('#ajapaik-invert-rephoto-overlay-button').show();
                }
            }
        }, function () {
            if (!isMobile) {
                if (!window.userClosedRephotoTools) {
                    $('#ajapaik-close-rephoto-overlay-button').hide();
                    $('#ajapaik-invert-rephoto-overlay-button').hide();
                }
            }
        });
        $('#ajapaik-rephoto-thumb-' + window.currentlySelectedRephotoId).click();
    });
</script>
{% verbatim %}
    <script id="ajapaik-photo-modal-rephoto-template" type="text/x-tmpl">
        <img src="{%=o.url%}" id="ajapaik-modal-rephoto" class="img-responsive col-xs-12">
        <button class="btn btn-default ajapaik-overlay-button ajapaik-close-rephoto-overlay-button"
            id="ajapaik-close-rephoto-overlay-button" {% if (!isMobile) { %}
            style="display: none;"{% } %}></button>
        <button class="btn btn-default ajapaik-overlay-button ajapaik-invert-rephoto-overlay-button"
            id="ajapaik-invert-rephoto-overlay-button" {% if (!isMobile) { %}
            style="display: none;"{% } %}></button>
    </script>
    <script id="ajapaik-photo-modal-rephoto-info-template" type="text/x-tmpl">
        {% if (o.source && o.sourceKey && o.sourceURL) { %}
            {% if (o.author) { %}
                <div class="row ajapaik-photo-modal-row"><b>{%=o.author%}</b>{% if (o.licence) { %}{% endverbatim %}{% include "_licence.html" %}{% verbatim %}{% } %}</div>
            {% } %}
            <div class="row ajapaik-photo-modal-row">
                <a onclick="window._gaq.push(['_trackEvent', 'Map', 'Source link click']);" href='{%=o.sourceURL%}'
                   target="_blank">
                    {%=o.source%} {%=o.sourceKey%}
                </a>
            </div>
        {% } else { %}
            {% if (o.author) { %}
                <div class="row ajapaik-photo-modal-row"><b>{%=o.author%}</b>{% endverbatim %}{% include "_licence.html" %}{% verbatim %}</div>
            {% } else { %}
                {% if (o.FBUserName) { %}
                    <div class="row ajapaik-photo-modal-row">
                        <a target="_blank" href="{%=o.FBUserLink%}">
                            {%=o.FBUserName%}
                        </a>
                        {% endverbatim %}{% include "_licence.html" %}{% verbatim %}
                    </div>
                {% } else { %}
                    <div class="row ajapaik-photo-modal-row"><b>{%=gettext('Unknown author')%}</b></div>
                {% } %}
            {% } %}
        {% } %}
        {% if (o.date) { %}
            <div class="row ajapaik-photo-modal-row">{%=o.date%}</div>
        {% } %}
    </script>
{% endverbatim %}