{% extends "base.html" %}
{% load i18n %}

{% block layout %}
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/justifiedGallery.min.css" />
    <script type="text/javascript">
        var leaderboardFullURL = "{% url "project.home.views.rephoto_top50" %}",
                geotaggedPhotos = {{ json_data|safe }},
                userAlreadySeenPhotoIds = {{ user_seen_photo_ids|safe }},
                cityId = {{ city_id|safe }},
                i,
                markers = [],
                p,
                thumb,
                image,
                blueIcon,
                blackIcon,
                currentIcon;

        function initialize() {
            if (QueryString.fromSelect) {
                window.fromSelect = true;
                History.replaceState(null, null, "/kaart/?city__pk=" + cityId);
            }
            {% if filters.filters_by_name.city_lookup_filter.get_option_object.lat and filters.filters_by_name.city_lookup_filter.get_option_object.lon %}
                window.getMap(
                    [
                        {{ filters.filters_by_name.city_lookup_filter.get_option_object.lon | safe }},
                        {{ filters.filters_by_name.city_lookup_filter.get_option_object.lat | safe }}
                    ],
                    13
                );
            {% else %}
                window.getMap();
            {% endif %}

            blackIcon = {
                url: "/static/images/ajapaik_marker_20px.png"
            };

            blueIcon = {
                url: "/static/images/ajapaik_marker_20px_blue.png"
            };

            for (i in geotaggedPhotos) {
                if (geotaggedPhotos.hasOwnProperty(i)) {
                    p = geotaggedPhotos[i];
                    if (p[4]) {
                        currentIcon = blueIcon;
                    } else {
                        currentIcon = blackIcon;
                    }
                    var marker = new google.maps.Marker({
                        map: window.map,
                        id: p[0],
                        thumb: p[1],
                        description: p[6],
                        rephotoCount: p[4],
                        icon: currentIcon,
                        position: new google.maps.LatLng(p[3], p[2]),
                        zIndex: 1,
                        azimuth: p[7],
                        thumbHeight: p[9],
                        thumbWidth: p[8]
                    });
                    (function (id) {
                        google.maps.event.addListener(marker, "click", function () {
                            highlightSelected(id, true);
                        });
                    })(p[0]);
                    markers.push(marker);
                }
            }
        }
        $(document).ready(initialize);
    </script>

    <div id="browse">
        <div class="top">
            <h1 class="ir">
                <a href="/?city__pk={{ filters.filters_by_name.city_lookup_filter.get_option_object.id }}">
                    {% trans "Timepatch (Ajapaik)" %}
                </a>
            </h1>
            <ul id="nav"></ul>
            <div class="score_container">
                <h2><a id="full_leaderboard" href="#">{% trans "Rephoto Leaderboard" %}</a></h2>
                <ul class="scoreboard">
                    {% for pos in leaderboard %}
                        <li class="clearfix{% if pos.1 %} you{% endif %}">
                            <span class="position">{{ pos.0 }}.</span>
                            <span class="photo">{% if pos.3 %}
                                <img src="http://graph.facebook.com/{{ pos.3 }}/picture?type=square"/>{% endif %}</span>
                            <span class="name">{% if pos.4 %}{{ pos.4 }}{% else %}
                                {% trans "Your points" %}{% endif %}</span>
                            <span class="score">{{ pos.2 }}</span>
                        </li>
                    {% endfor %}
                </ul>
                {% if request.user.is_authenticated and request.user.profile.fb_id %}
                    {% with profile=request.user.profile user=request.user %}
                        <div id="facebook-connected">
                            <p>
                                {% blocktrans with "<a id='logout-button' href='/logout'>" as link_open and "</a>" as link_close and user.get_full_name as account_name %}
                                    Account ({{ account_name }}) connected. If it"s not you then {{ link_open }}click
                                    here{{ link_close }}.{% endblocktrans %}</p>
                        </div>
                    {% endwith %}
                {% else %}
                    <div id="facebook-connect">
                        <p>{% trans "Facebook Connect to save your score and continue later." %}</p>
                        <a href="/facebook/login" class="ir">{% trans "Connect with Facebook" %}</a>
                    </div>
                    {% comment %}
                    <div id="google-plus-connect">
                        <p>{% trans "Connect with Google plus to save your score and continue later." %}</p>
                        <a id="google-plus-login-button" href="/google_login" class="ir">
                            {% trans "Connect with Google+" %}
                        </a>
				    </div>
				    {% endcomment %}
                {% endif %}
            </div>
            <div class="filter-box">
                {{ filters.get_form.as_p }}
            </div>
        </div>
        <div id="photo-drawer"></div>
        <div class="map">
            <div id="map_canvas" style="width: 100%; height: 100%"></div>
        </div>
        <div id="photo-pane-container">
            <div id="photo-pane">
                {% for element in data %}
                    <a id="element{{ element.0 }}"
                       data-id="{{ element.0 }}"
                       onclick="window.highlightSelected({{ element.0 }}, false);">
                        <img src=""
                             data-src="{{ element.1 }}"
                             title="{{ element.6 }}"
                             data-id="{{ element.0 }}"
                             class="lazyload" height="{{ element.9 }}"
                             width="{{ element.8 }}"
                             onmouseover="(function(e) {paneImageHoverIn(e)})(this)"
                             onmouseout="(function(e) {paneImageHoverOut(e)})(this)"/>
                        <div class="ajapaik-eye-open {% if element.0 in user_seen_photo_ids %}ajapaik-eye-open-light-bg{% endif %}"
                             data-id="{{ element.0 }}"
                             id="eye{{ element.0 }}"
                             style="display: none;"
                             onclick="(function(e) {_gaq.push(['_trackEvent', 'Map', 'Pane photo eye click']); window.loadPhoto(e.dataset.id);})(this)"
                             onmouseover="(function(e) {paneEyeHoverIn(e)})(this)"
                             onmouseout="(function(e) {paneEyeHoverOut(e)})(this)">
                        </div>
                        {% if element.7 %}
                        <div class="ajapaik-azimuth"
                             data-id="{{ element.0 }}"
                             style="display: none;"
                             onmouseover="(function(e) {paneAzimuthHoverIn(e)})(this)"
                             onmouseout="(function(e) {paneAzimuthHoverOut(e)})(this)">
                        </div>
                        {% endif %}
                        {% if element.4 %}
                        <div class="ajapaik-rephoto-count"
                             data-id="{{ element.0 }}"
                             style="display: none;"
                             onmouseover="(function(e) {paneRephotoCountHoverIn(e)})(this)"
                             onmouseout="(function(e) {paneRephotoCountHoverOut(e)})(this)">
                            {{ element.4 }}
                        </div>
                        {% endif %}
                    </a>
                {% endfor %}
            </div>
        </div>
    </div>
    <div style="display: none;">
        <div id="leaderboard_browser">
            <div class="single">
                <a style="position:absolute;top:5px;right:10px;" href="javascript:void(0);" onclick="$.modal.close();">
                    {% trans "Close" %}
                </a>
                <div class="score_container">
                    <ul class="scoreboard" style="max-height:300px;overflow-y:auto;padding-right:10px;"></ul>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&v=3&libraries=visualization"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/lazysizes-0.5.0.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/jquery.justifiedGallery-3.4.0.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/init.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/browse.js"></script>
{% endblock layout %}